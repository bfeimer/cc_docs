var oTable,aoColumns;function escapeHtml(text){var map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,function(m){return map[m]})}$(document).ready(function(){var chooserVal="open";$.ajax({url:"lib/php/data/cases_columns_load.php",dataType:"json",error:function(){alert("Sorry, there is an error in your ClinicCases configuration");return true},success:function(data){if(data){aoColumns=data.aoColumns;oTable=$("#table_cases").dataTable({bJQueryUI:true,bProcessing:true,bScrollInfinite:true,bScrollCollapse:true,bSortCellsTop:true,bStateSave:true,iCookieDuration:60*60*24*365,sScrollY:adjustedHeight-95,iDisplayLength:50,aaSorting:[[4,"asc"]],aoColumns:aoColumns,sDom:"R<'H'fTCi>rt",oColVis:{aiExclude:[0,6,7],bRestore:true,buttonText:"Columns",fnStateChange:function(iColumn,bVisible){$("div.dataTables_scrollHeadInner thead th.addSelects:empty").each(function(){this.innerHTML=fnCreateSelect(oTable.fnGetColumnData(iColumn,true,false,true))})}},oTableTools:{sSwfPath:"lib/DataTables-1.8.2/extras/TableTools/media/swf/copy_cvs_xls_pdf.swf",aButtons:[{sExtends:"collection",sButtonText:"Print/Export",aButtons:[{sExtends:"copy",mColumns:"visible"},{sExtends:"csv",mColumns:"visible"},{sExtends:"xls",mColumns:"visible"},{sExtends:"pdf",mColumns:"visible"},{sExtends:"print",mColumns:"visible"}]},{sExtends:"text",sButtonText:"Reset",sButtonClass:"DTTT_button_reset",sButtonClassHover:"DTTT_button_reset_hover"},{sExtends:"text",sButtonText:"New Case",sButtonClass:"DTTT_button_new_case",sButtonClassHover:"DTTT_button_new_case_hover"}]},sAjaxSource:"lib/php/data/cases_load.php",bDeferRender:true,aoColumnDefs:[{fnRender:function(o){return String(o.aData[o.iDataColumn]).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},aTargets:["_all"]}],fnInitComplete:function(){oTable.fnFilter("^$",oTable.fnGetColumnIndex("Date Close"),true,false);$(window).bind("resize",function(){oTable.fnDraw(false);oTable.fnAdjustColumnSizing()});$("div.dataTables_scrollHeadInner thead th.addSelects").each(function(){var columnIndex=oTable.fnGetColumnIndex($(this).attr("name"));this.innerHTML=fnCreateSelect(oTable.fnGetColumnData(columnIndex,true,false,true))});$("div.dataTables_filter").append('<select id="chooser"><option value="open" '+'selected=selected>Open Cases Only</option><option value="closed">Closed Cases Only'+'</option><option value="all">All Cases</option></select>  <a href="#" id="set_advanced">'+"Advanced Search</a>");$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default");$("#ToolTables_table_cases_6").click(function(){fnResetAllFilters()});if(!$("#table_cases").hasClass("can_add")){$("#ToolTables_table_cases_7").remove()}else{$("#ToolTables_table_cases_7").click(function(){$.post("lib/php/utilities/create_new_case.php",function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{var newId=serverResponse.newId;callCaseWindow(newId,true)}})})}$("#chooser").live("change",function(event){switch($(this).val()){case"all":chooserVal="open and closed";oTable.fnFilter("",oTable.fnGetColumnIndex("Date Close"));break;case"open":chooserVal="open";oTable.fnFilter("^$",oTable.fnGetColumnIndex("Date Close"),true,false);break;case"closed":chooserVal="closed";oTable.fnFilter("^.+$",oTable.fnGetColumnIndex("Date Close"),true,false);break}});$("#set_advanced").live("click",function(event){event.preventDefault();if($("tr.advanced, tr.advanced_2").css("display")!=="none"){$("tr.advanced, tr.advanced_2").css({display:"none"})}else{$("th.ui-state-default").css({"border-bottom":"0px"});$(".complex").children().css({display:"inline","margin-bottom":"0px"});$("#open_range , #close_range").css({"margin-top":"18px"});$("thead tr.advanced").toggle("slow");$("#second_open_cell, #second_close_cell").css({visibility:"hidden"});oTable.fnFilter("",oTable.fnGetColumnIndex("Date Close"),true,false);$("#chooser").val("all");chooserVal="open and closed"}oTable.fnDraw()});$("#addopenRow").click(function(event){event.preventDefault();if($("#second_open_cell").css("visibility")==="visible"){$(this).text("Add Condition");$("#second_open_cell").css({visibility:"hidden"});$("thead tr.advanced_2").hide("slow")}else{$(this).text("AND IS");$("#second_open_cell").css({visibility:"visible"});$("#date_open_2 , #date_close_2").css({width:"60%"});$("thead tr.advanced_2").show("slow")}});$("#addcloseRow").click(function(event){event.preventDefault();if($("#second_close_cell").css("visibility")==="visible"){$(this).text("Add Condition");$("#second_close_cell").css({visibility:"hidden"});$("thead tr.advanced_2").hide("slow")}else{$(this).text("AND IS");$("#second_close_cell").css({visibility:"visible"});$("#date_open_2 , #date_close_2").css({width:"60%"});$("thead tr.advanced_2").show("slow")}});$("thead input").live("keyup",function(){var colName=$(this).attr("name");var colIndex=oTable.fnGetColumnIndex(colName);oTable.fnFilter(this.value,colIndex)});$("div.dataTables_scrollHeadInner tr.advanced th.addSelects select").live("change",function(){var Oparent=$(this).parent();var colIndex=oTable.fnGetColumnIndex(Oparent.attr("name"));var val=this.value;var regex="^"+val+"$";oTable.fnFilter(regex,colIndex,true,false,false)});$(function(){$("#date_open , #date_close, #date_open_2, #date_close_2").datepicker({changeMonth:true,changeYear:true,onSelect:function(){$(this).css({color:"black"});oTable.fnDraw()}})});$("#open_range, #open_range_2, #close_range, #close_range_2").live("change",function(event){oTable.fnDraw()});$("#table_cases tbody").click(function(event){var iPos=oTable.fnGetPosition(event.target.parentNode);var aData=oTable.fnGetData(iPos);var iId=aData[0];callCaseWindow(iId)});$("#table_cases").addClass("print_content");$("tr.advanced, tr.advanced_2").addClass("print_content_no");$("#ToolTables_table_cases_5").live("click",function(){var dialogWin=$('<div class="dialog-casenote-delete" title="Print">Please use your '+"browser's print function to print this table. Press escape when finished.</div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{OK:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$("#processing").hide()},oLanguage:{sInfo:'Found <b>_TOTAL_</b> <span id="caseStatus"></span> cases',sInfoFiltered:"from a total of <b>_MAX_</b> cases",sEmptyTable:"No cases found.",sZeroRecords:"No cases found."},fnDrawCallback:function(){$("#caseStatus").text(chooserVal);$(".hasDatepicker").css({width:"60%"});$(".complex").css({"min-width":"160px"})}});router()}}});function fnResetAllFilters(){var oSettings=oTable.fnSettings();for(iCol=0;iCol<oSettings.aoPreSearchCols.length;iCol++){oSettings.aoPreSearchCols[iCol].sSearch=""}oTable.fnFilter("");ColReorder.fnReset(oTable);$("input").each(function(){this.value=""});$("select").each(function(){this.selectedIndex="0"});$("#addOpenRow, #addCloseRow").each(function(){$(this).text("Add Condition")});$("#second_open_cell, #second_close_cell").css({visibility:"hidden"});$("thead tr.advanced_2").hide("slow");oTable.fnFilter("^$",oTable.fnGetColumnIndex("Date Close"),true,false);chooserVal="open";oTable.fnSort([[oTable.fnGetColumnIndex("Last Name"),"asc"]]);oTable.fnDraw()}});$.fn.dataTableExt.afnFiltering.push(function(oSettings,aData,iDataIndex){var opOperator=document.getElementById("open_range").value;var opOperator2=document.getElementById("open_range_2").value;var clOperator=document.getElementById("close_range").value;var clOperator2=document.getElementById("close_range_2").value;var opFieldRaw=document.getElementById("date_open").value;var opFieldRaw2=document.getElementById("date_open_2").value;var clFieldRaw=document.getElementById("date_close").value;var clFieldRaw2=document.getElementById("date_close_2").value;var opRowRaw=aData[6];var clRowRaw=aData[7];var opField=opFieldRaw.substring(6,10)+opFieldRaw.substring(0,2)+opFieldRaw.substring(3,5);var opField2=opFieldRaw2.substring(6,10)+opFieldRaw2.substring(0,2)+opFieldRaw2.substring(3,5);var clField=clFieldRaw.substring(6,10)+clFieldRaw.substring(0,2)+clFieldRaw.substring(3,5);var clField2=clFieldRaw2.substring(6,10)+clFieldRaw2.substring(0,2)+clFieldRaw2.substring(3,5);var opRow=opRowRaw.substring(6,10)+opRowRaw.substring(0,2)+opRowRaw.substring(3,5);var clRow=clRowRaw.substring(6,10)+clRowRaw.substring(0,2)+clRowRaw.substring(3,5);if(opField===""&&clField===""){return true}if(opField!==""&&clField===""&&opField2===""&&clField2===""){if(opOperator==="equals"&&opRow===opField){return true}else if(opOperator==="less"&&opRow<opField){return true}else if(opOperator==="greater"&&opRow>opField){return true}}if(opField===""&&clField!==""&&opField2===""&&clField2===""){if(clOperator==="equals"&&clRow===clField){return true}else if(clOperator==="less"&&clRow<clField){return true}else if(clOperator==="greater"&&clRow>clField){return true}}if(opField!==""&&clField!==""&&opField2===""&&clField2===""){if(opOperator==="equals"&&clOperator==="equals"&&opRow===opField&&clRow===clField){return true}else if(opOperator==="greater"&&clOperator==="less"&&opRow>opField&&clRow<clField){return true}else if(opOperator==="less"&&clOperator==="greater"&&opRow<opField&&clRow>clField){return true}}if(opField!==""&&clField===""&&opField2!==""&&clField2===""){if(opOperator==="equals"&&opOperator2==="equals"&&opRow===opField&&opRow===opField2){return true}else if(opOperator==="greater"&&opOperator2==="less"&&opRow>opField&&opRow<opField2){return true}else if(opOperator==="less"&&opOperator2==="greater"&&opRow<opField&&opRow>opField2){return true}}if(opField===""&&clField!==""&&opField2===""&&clField2!==""){if(clOperator==="equals"&&clOperator2==="equals"&&clRow===clField&&clRow===clField2){return true}else if(clOperator==="greater"&&clOperator2==="less"&&clRow>clField&&clRow<clField2){return true}else if(clOperator==="less"&&clOperator2==="greater"&&clRow<clField&&clRow>clField2){return true}}if(opField!==""&&clField!==""&&opField2!==""&&clField2!==""){if(opOperator==="equals"&&opOperator2==="equals"&&clOperator==="equals"&&opOperator2==="equals"&&opRow===opField&&opRow===opField2&&clRow===clField&&clRow===clField2){return true}else if(opOperator==="greater"&&opOperator2==="less"&&clOperator==="greater"&&opOperator2==="less"&&opRow>opField&&opRow<opField2&&clRow>clField&&clRow<clField2){return true}}if(opField!==""&&clField!==""&&opField2!==""&&clField2===""){if(opOperator==="greater"&&opOperator2==="less"&&clOperator==="equals"&&opRow>opField&&opRow<opField2&&clRow===clField){return true}if(opOperator==="greater"&&opOperator2==="less"&&clOperator==="greater"&&opRow>opField&&opRow<opField2&&clRow>clField){return true}if(opOperator==="greater"&&opOperator2==="less"&&clOperator==="less"&&opRow>opField&&opRow<opField2&&clRow<clField){return true}}if(opField!==""&&clField!==""&&opField2===""&&clField2!==""){if(clOperator==="greater"&&clOperator2==="less"&&opOperator==="equals"&&clRow>clField&&clRow<clField2&&opRow===opField){return true}if(clOperator==="greater"&&clOperator2==="less"&&opOperator==="greater"&&clRow>clField&&clRow<clField2&&opRow>opField){return true}if(clOperator==="greater"&&clOperator2==="less"&&opOperator==="less"&&clRow>clField&&clRow<clField2&&opRow<opField){return true}}return false});function formatCaseData(thisPanel,type){var navItem=thisPanel.siblings(".case_detail_nav").find("#item2");var toolsHeight=navItem.outerHeight();var thisPanelHeight=navItem.closest(".case_detail_nav").height();var documentsWindowHeight=thisPanelHeight-toolsHeight;if(typeof caseNotesWindowHeight==="undefined"){var caseNotesWindowHeight=thisPanelHeight-toolsHeight}$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:caseNotesWindowHeight});$("div.case_detail_panel_tools_left").css({width:"30%"});$("div.case_detail_panel_tools_right").css({width:"70%"});thisPanel.find("div.case_data_value").not("div.case_data_name + div.case_data_value").css({"margin-left":"21%"});$(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}});if(type==="new"||type==="edit"){thisPanel.find('input[name="id"]').parent().hide();thisPanel.find('input[name="opened_by"]').parent().remove();if(thisPanel.find('input[name="organization"]').val()==="New Case"){thisPanel.find('input[name="organization"]').val("")}var cN=thisPanel.find('input[name="clinic_id"]');var cnVal=cN.val();if(cnVal.indexOf("ClinicType")!==-1){thisPanel.find('select[name="clinic_type"]').change(function(){cN.val(cnVal.replace("ClinicType",$(this).find("option:selected").attr("data-code")))})}if(cnVal.indexOf("CaseType")!==-1){thisPanel.find('select[name="case_type"]').change(function(){cN.val(cnVal.replace("CaseType",$(this).find("option:selected").attr("data-code")))})}$(window).bind("beforeunload",function(){return"You may have unsaved changes on a case.  Please "+"either save any changes or close the case's tab before leaving this page"});thisPanel.find('input[name="clinic_id"]').attr("disabled",true).after('<a class="force_edit small" href="#">Let me edit this</a>');thisPanel.find("a.force_edit").click(function(event){event.preventDefault();var dialogWin=$('<div class="dialog-casenote-delete" title="Are you sure?"><p>'+"ClinicCases automatically assigns the next available case number.  If your "+'case number contains "CaseType" or "ClinicType", these values will be '+"replaced when you change those fields below.</p><br /><p>Manually editing "+"a case number may have undesirable results. Are you sure?</p></div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$('input[name="clinic_id"]').attr("disabled",false).focus();thisPanel.find("a.force_edit").remove();$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});if(thisPanel.find('input[name="date_close"]').val()!==""){thisPanel.find('input[name="date_close"]').after('<a class="force_reopen small" href="#">Re-open this case</a>');thisPanel.find("a.force_reopen").click(function(event){event.preventDefault();var dialogWin=$('<div class="dialog-casenote-delete" title="Are you sure?">'+"<p>This will re-open the case. Are you sure?</p></div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$('input[name="date_close"]').datepicker("setDate",null).next().html("");$('select[name="dispo"]').val("").trigger("liszt:updated");thisPanel.find("a.force_reopen").remove();$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")})}thisPanel.find("select").chosen();thisPanel.find("span.dual_input").not("label + span.dual_input").css({"margin-left":"190px"});thisPanel.find("span.multi-text").not("label + span.multi-text").css({"margin-left":"190px"});thisPanel.find("p").has("span.dual_input").each(function(){$(this).find("span.dual_input").last().after('<a class="add_another small" href="#">Add another</a>')});thisPanel.find("p").has("span.multi-text").each(function(){$(this).find("span.multi-text").last().after('<a class="add_another small" href="#">Add another</a>')});thisPanel.find("input.date_field").each(function(){var b=$.datepicker.parseDate("yy-mm-dd",$(this).val());var buttonVal=$.datepicker.formatDate("mm/dd/yy",b);$(this).datepicker({dateFormat:"yy-mm-dd",showOn:"button",buttonText:buttonVal,onSelect:function(dateText){var c=$.datepicker.parseDate("yy-mm-dd",dateText);var displayDate=$.datepicker.formatDate("mm/dd/yy",c);$(this).next().html(displayDate)}})});thisPanel.find("textarea").TextAreaExpander(100,250);$("#case_detail_tab_row").find("li.ui-state-active").addClass("ui-state-highlight");thisPanel.find('input[name="first_name"]').focus();$('input[name = "last_name"]').keyup(function(){var fname=thisPanel.find('input[name="first_name"]').val();$(this).closest("#case_detail_tab_row").find("li.ui-state-active").find("a").html(escapeHtml($(this).val())+", "+escapeHtml(fname));$(this).closest("#case_detail_tab_row").find("div.case_title").html("<h2>"+escapeHtml(fname)+" "+escapeHtml($(this).val())+"</h2>")});$('input[name = "organization"]').keyup(function(){var lnameVal=$(this).closest("form").find('input[name="last_name"]').val();if(lnameVal===""){$(this).closest("#case_detail_tab_row").find("li.ui-state-active").find("a").html(escapeHtml($(this).val()));$(this).closest("#case_detail_tab_row").find("div.case_title").html("<h2>"+escapeHtml($(this).val())+"</h2>")}})}else{thisPanel.find("button.case_data_edit").button({icons:{primary:"fff-icon-page-edit"},text:true});thisPanel.find("button.case_data_delete").button({icons:{primary:"fff-icon-bin-closed"},text:true});thisPanel.find("button.case_data_print").button({icons:{primary:"fff-icon-printer"},text:true});thisPanel.find("div.id_display").remove()}}$(".case_detail_nav #item2").live("click",function(){var thisPanel=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");var caseId=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");var type;if($(this).hasClass("new_case")){type="new"}else{type="display"}thisPanel.load("lib/php/data/cases_case_data_load.php",{id:caseId,type:type},function(){formatCaseData(thisPanel,type)})});$("button.case_data_edit").live("click",function(){var thisPanel=$(this).closest(".case_detail_panel");var thisCaseId=thisPanel.data("CaseNumber");thisPanel.load("lib/php/data/cases_case_data_load.php",{id:thisCaseId,type:"edit"},function(){formatCaseData(thisPanel,"edit")})});$("button.case_data_delete").live("click",function(){var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var tgt=$(this).closest(".ui-tabs-panel").attr("id");var dialogWin=$('<div class="dialog-casenote-delete" title="Are you sure?"><p>'+"This will completely delete this case and all its associated data. <br /><b>This cannot be undone</b>.</p>"+"<p>Are you sure?</p></div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/cases_case_data_process.php",{id:caseId,action:"delete"},function(data){var serverResponse=$.parseJSON(data);if(!serverResponse.error){var el=$('a[href="#'+tgt+'"]').closest("li");closeCaseTab(true,el);oTable.fnReloadAjax()}notify(serverResponse.message)});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$("button.case_modify_submit").live("click",function(event){event.preventDefault();var resultTarget=$(this).closest(".case_detail_panel");var thisCaseId=resultTarget.data("CaseNumber");var actionType;if($(this).hasClass("update_new_case")){actionType="update_new_case"}else{actionType="edit"}$(window).unbind("beforeunload");var formVals=$(this).closest("form");formVals.find('input[name="clinic_id"]').attr({disabled:false});var errString=newCaseValidate(formVals);var formValsArray=formVals.serializeArray();if(errString.length){notify(errString,true);$(window).bind("beforeunload",function(){return"You may have unsaved changes on a case.  Please either save"+" any changes or close the case's tab before leaving this page"});$("input.ui-state-error").focus(function(){$(this).removeClass("ui-state-error")});return false}else{var formValsOk=$(this).closest("form").find(":not(span.dual_input input, span.dual_input select, span.multi-text input)").serializeArray();formValsOk.push({name:"action",value:actionType});formVals.find("p").has(".multi-text").each(function(){var dataObj={};var dataName=$(this).find("input").attr("name");$(this).find("span.multi-text").each(function(){var dataValue=$(this).find("input").val();if(dataValue.length>0){dataObj[dataValue]="name"}});if(!$.isEmptyObject(dataObj)){var dataJson=JSON.stringify(dataObj);formValsOk.push({name:dataName,value:dataJson})}});formVals.find("p").has(".dual_input").each(function(){var dataObj={};var dataName=$(this).find("input:last").attr("name");$(this).find("span.dual_input").each(function(){var dataType=$(this).find("select.dual").val();var dataValue=$(this).find("input:last").val();if(dataValue.length>0){dataObj[dataValue]=dataType}});if(!$.isEmptyObject(dataObj)){var dataJson=JSON.stringify(dataObj);formValsOk.push({name:dataName,value:dataJson})}});$.post("lib/php/data/cases_case_data_process.php",formValsOk,function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);$("#case_detail_tab_row").find("li.ui-state-active").removeClass("ui-state-highlight ui-state-error new_case");resultTarget.load("lib/php/data/cases_case_data_load.php",{id:thisCaseId,type:"display"},function(){formatCaseData(resultTarget,"display")});oTable.fnReloadAjax();checkConflicts(thisCaseId)}})}});$("button.case_cancel_submit").live("click",function(event){event.preventDefault();var thisPanel=$(this).closest(".case_detail_panel");var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var type;if($(this).hasClass("cancel_new_case")){var dialogWin=$('<div class="dialog-casenote-delete" title="Are you sure?"><p>'+"This will delete your new case. Are you sure?</p></div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/cases_case_data_process.php",{id:caseId,action:"delete"},function(data){var serverResponse=$.parseJSON(data);if(!serverResponse.error){var el=$("li.new_case.ui-state-active");closeCaseTab(true,el)}notify(serverResponse.message)});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")}else{type="display";thisPanel.load("lib/php/data/cases_case_data_load.php",{id:caseId,type:type},function(){formatCaseData(thisPanel,type)})}$(window).unbind("beforeunload")});$("button.case_data_print").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Case Data: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())});$("a.add_another").live("click",function(event){event.preventDefault();var newField=$(this).prev("span").clone();newField.find("input").val("");newField.find("select").val("");newField.css({"margin-left":"190px"});newField.find("select").removeClass("chzn-done").css({display:"block"}).removeAttr("id").next("div").remove();$(this).prev("span").after(newField);newField.find("select").chosen();newField.find("input").focus()});var $tabs,panelTarget;function setDetailCss(){var windowWidth=Math.ceil($("#case_detail_window").width());var windowHeight=Math.ceil($("#case_detail_window").height());var panelWidthFix=$("#case_detail_window").width()*.004;var navWidth=Math.floor(windowWidth*.15);var panelWidth=windowWidth-navWidth-panelWidthFix-10;var bh=Math.floor($(windowHeight*.07));var barHeight;if(bh>52){barHeight=bh}else{barHeight=52}var navHeight=windowHeight-$("#case_detail_tab_row").height()-barHeight;var barWidth=windowWidth-3;var panelHeight=navHeight;var caseTitleHeight=barHeight-10;$(".case_detail_nav").css({height:navHeight,width:navWidth});$(".case_detail_panel").css({height:panelHeight,width:panelWidth});$(".case_detail_bar").css({height:barHeight,width:barWidth});$(".case_title").css({height:caseTitleHeight})}function addDetailTabs(id,newCase){$(function(){var numberTabs=$("ul.ui-tabs-nav > li").length;var tabData,scroller;if(numberTabs===5){$("#error").text("Sorry, but ClinicCases can only open a maximum of five cases at a time.").dialog({modal:true,title:"Error"});return false}$.getJSON("lib/php/data/cases_detail_tab_case_name.php?id="+id,function(data){if(data.organization.length<1){tabData=data.last_name+", "+data.first_name}else{tabData=data.organization}if(tabData.length>12){tabData=tabData.substring(0,12)+"..."}$tabs=$("#case_detail_tab_row").tabs({tabTemplate:'<li><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>'});$tabs.tabs("add","lib/php/data/cases_detail_load.php?id="+id,tabData);$tabs.tabs({add:function(event,ui){$tabs.tabs("select","#"+ui.panel.id)},cache:true,load:function(event,ui){setDetailCss();$("#case_detail_bar").text(tabData);if(newCase===true){$(ui.tab).parent().addClass("new_case")}if($("div.assigned_people  button").length>0){$("div.assigned_people  button").button({icons:{primary:"fff-icon-user-add"},text:true})}panelTarget=ui.panel;$(panelTarget).find(" .case_detail_panel").data("CaseNumber",id);if(newCase===true){$(panelTarget).find(".case_detail_nav li#item2").addClass("new_case").trigger("click")}else{loadCaseNotes(panelTarget,id);checkConflicts(id)}$(".assigned_people").jScrollPane({autoReinitialise:true})}});$("ul.ui-tabs-nav").removeClass("ui-corner-all").addClass("ui-corner-top");$("#case_detail_tab_row").removeClass("ui-corner-all").addClass("ui-corner-top")})})}function callCaseWindow(id,newCase){if($("#case_detail_window").length<1){var caseDetail='<div id="case_detail_window"><div id="case_detail_tab_row"><ul></ul><div id="case_detail_control"></div></div></div>';$("#content").append(caseDetail);$("#case_detail_window").hide().show("fold",600,function(){setDetailCss();addDetailTabs(id,newCase)});$("#case_detail_control").html("<button></button><button></button>");$("#case_detail_control button:first").button({icons:{primary:"fff-icon-arrow-in"},label:"Minimize"}).next().button({icons:{primary:"fff-icon-cancel"},label:"Close"})}else{if($("#case_detail_control button:first").text()==="Maximize"){toggleTabs();addDetailTabs(id,newCase)}else{$("#case_detail_window").hide().show("fold",600,function(){setDetailCss();addDetailTabs(id,newCase)})}}}function toggleTabs(){var minimized=adjustedHeight+8;if($("#case_detail_control button:first").text()==="Minimize"){$("#case_detail_window").animate({top:minimized});$("#case_detail_control button:first").button({icons:{primary:"fff-icon-arrow-out"},label:"Maximize"});$("#case_detail_control button:first .ui-button-text").css({"line-height":"0.3"})}else{var paddingTop=adjustedHeight*.021;$("#case_detail_window").animate({top:paddingTop});$("#case_detail_control button:first").button({icons:{primary:"fff-icon-arrow-in"},label:"Minimize"});$("#case_detail_control button:first .ui-button-text").css({"line-height":"0.3"})}}function closeCaseTab(canClose,el){if(canClose===true){var index=$("li",$tabs).index(el);var numberTabs=$("ul.ui-tabs-nav > li").length;if(numberTabs===1){$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")})}else{$tabs.tabs("remove",index)}}}function tabCheckDirty(el){var dialogWin=$('<div title="Warning: Unsaved Changes">You are currently editing a case. Lose any changes?</div>');var targetPanel=el.find("a").attr("href");var caseId=$(targetPanel).find(".case_detail_panel").data("CaseNumber");if(el.first().hasClass("ui-state-highlight")){el.addClass("ui-state-error");dialogWin.dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){if(el.size()>1&&el.hasClass("new_case")){var errors=[];el.each(function(){targetPanel=$(this).find("a").attr("href");caseId=$(targetPanel).find(".case_detail_panel").data("CaseNumber");$.post("lib/php/data/cases_case_data_process.php",{action:"delete",id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){errors.push("error")}})});if(errors.length>0){notify("Sorry, there was an error",true)}else{notify("Cases deleted.");$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")});$(window).unbind("beforeunload")}}else if(el.hasClass("new_case")){$.post("lib/php/data/cases_case_data_process.php",{action:"delete",id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);closeCaseTab(true,el);$(window).unbind("beforeunload")}})}else if(el.size()>1){$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")});$(window).unbind("beforeunload")}else{closeCaseTab(true,el);$(window).unbind("beforeunload")}$(this).dialog("destroy")},No:function(){closeCaseTab(false);$(this).dialog("destroy")}}});$(dialogWin).dialog("open")}else{closeCaseTab(true,el)}}function checkConflicts(caseId){$.post("lib/php/data/cases_conflicts_load.php",{case_id:caseId,type:"alert"},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.conflicts===true){$(panelTarget).find("span.conflicts_number").html('<span class="msg_number"> ('+serverResponse.number+")</span>")}})}$("#case_detail_control button:first").live("click",function(){toggleTabs()});$("#case_detail_control button + button").live("click",function(){var aDirtyTab=$("#case_detail_tab_row").find("li.ui-state-highlight");if(!$.isEmptyObject(aDirtyTab)){tabCheckDirty(aDirtyTab)}else{$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")})}});$("ul.case_detail_nav_list > li").live("click",function(){$(this).siblings().removeClass("selected");$(this).addClass("selected")});$("div.assigned_people img:not(.user_add_button)").live("click",function(){$("div.assigned_people img").css({border:"3px solid #FFFFCC"});var clickedImage=$(this);if($(this).parents("li").hasClass("inactive")){$(this).css({border:"3px solid gray"})}else{$(this).css({border:"3px solid green"})}var pos1=$(this).attr("id").indexOf("_");var pos2=$(this).attr("id").lastIndexOf("_");var getCaseId=$(this).attr("id").substring(pos1+1,pos2);var getUserId=$(this).attr("id").substring(pos2+1);$("div.user_display").load("lib/php/users/cases_detail_user_activity_load.php",{case_id:getCaseId,username:getUserId},function(){if($("div.user_display_detail button").length>0){if($("div.user_display_detail button").parent().hasClass("inactive_user")){$("button.user-action-button").button({icons:{primary:"fff-icon-user-delete"},text:true,label:"Reassign"})}else{$("button.user-action-button").button({icons:{primary:"fff-icon-user-delete"},text:true,label:"Unassign"})}}$(this).show();var userDetail=$(this).find("div.user_display_detail");userDetail.focus();userDetail.blur(function(){setTimeout(function(){userDetail.parent().hide();clickedImage.css({border:"3px solid #FFFFCC"})},500)})})});$("div.assigned_people li.slide").live("click",function(){var inactiveUsers=$("div.assigned_people li.inactive");var inactiveUsersDisplay=inactiveUsers.css("display");if(inactiveUsersDisplay==="none"){inactiveUsers.css({display:"inline"});inactiveUsers.find("img").css({opacity:".4"});$(this).children().text("Assigned (History):");$(this).removeClass("closed").addClass("open")}else{inactiveUsers.css({display:"none"});$(this).children().text("Assigned:");$(this).removeClass("open").addClass("closed")}});$("div.assigned_people img.user_add_button").live("click",function(){$("div.assigned_people img").css({border:"3px solid #FFFFCC","border-radius":"50%"});var userAddImage=$(this);$(this).css({border:"3px solid green","border-radius":"50%"});var pos=$(this).attr("id").lastIndexOf("_");var cseId=$(this).attr("id").substring(pos+1);userAddImage.css({border:"3px solid #FFFFCC"});$("div.user_display").load("lib/php/users/cases_detail_user_chooser_load.php",{case_id:cseId},function(){$("button.user-action-adduser-button").button({icons:{primary:"fff-icon-user-add"},text:true});$("div.user_display").show();$(".chzn-select").chosen();$("div.user_display form").focus().blur(function(){setTimeout(function(){$("div.user_display").hide()},500)})})});$("div.user_widget button.user-action-adduser-button").live("click",function(){var usersArray=$(this).parent().find("select").val();var usersCaseId=$("#user_chooser_case_id").val();$.ajax({url:"lib/php/users/add_user_to_case.php",data:{users_add:usersArray,case_id:usersCaseId},success:function(data){$(".assigned_people ul").load("lib/php/users/cases_detail_assigned_people_refresh_load.php",{id:usersCaseId});$("div.user_widget").hide();notify(data);oTable.fnReloadAjax();

}})});$("div.user_widget button.user-action-button").live("click",function(){var dialogWin=$(this).siblings(".dialog-user-remove");var formObj=$(this).siblings("form");var assignId=formObj.children(".RemoveId").val();var imgId=formObj.children(".RemoveImgId").val();var caseId=imgId.split("_");$(dialogWin).dialog({resizable:false,modal:true,buttons:{Yes:function(){$.ajax({url:"lib/php/users/remove_user_from_case.php",data:{remove_id:assignId},success:function(data){$("div.user_widget").hide();notify(data);$(".assigned_people ul").load("lib/php/users/cases_detail_assigned_people_refresh_load.php",{id:caseId[1]});oTable.fnReloadAjax()}});$(this).dialog("close")},No:function(){$(this).dialog("close")}}})});$("span.ui-icon-close").live("click",function(){tabCheckDirty($(this).parent())});$(window).resize(function(){setDetailCss()});function sizeCaseNotes(notes,panelTarget){var windowHeight=panelTarget.height();var minCaseNoteHeight=panelTarget.height()*.3;notes.each(function(){$(this).data("maxCaseNoteHeight",$(this).height());$(this).data("minCaseNoteHeight",minCaseNoteHeight);var notePercent=$(this).height()/windowHeight*100;if(notePercent>40){$(this).height(minCaseNoteHeight);$(this).css({overflow:"hidden"});$(this).append('<div class="more"><a href="#">More</a></div>')}})}String.prototype.nl2br=function(){var br;if(typeof arguments[0]!=="undefined"){br=arguments[0]}else{br="<br />"}return this.replace(/\r\n|\r|\n/g,br)};String.prototype.br2nl=function(){var nl;if(typeof arguments[0]!=="undefined"){nl=arguments[0]}else{nl="\r"}return this.replace(/\<br(\s*\/|)\>/g,nl)};function addMoreNotes(scrollTarget){var caseId=scrollTarget.data("CaseNumber");var scrollAmount=scrollTarget[0].scrollTop;var scrollHeight=scrollTarget[0].scrollHeight;var startNum;if(scrollAmount===0&&scrollTarget.hasClass("csenote_shadow")){scrollTarget.removeClass("csenote_shadow")}else{scrollTarget.addClass("csenote_shadow")}var scrollPercent=scrollAmount/(scrollHeight-scrollTarget.height())*100;if(scrollPercent>70){if(typeof scrollTarget.data("start")==="undefined"){startNum=20;scrollTarget.data("start",startNum)}else{startNum=scrollTarget.data("start")+20;scrollTarget.data("start",startNum)}$.post("lib/php/data/cases_casenotes_load.php",{case_id:caseId,start:scrollTarget.data("start"),update:"yes"},function(data){var t=$(data).find("p.csenote_instance").length;if(t===0){return false}else{scrollTarget.append(data);sizeCaseNotes($(".csenote"),scrollTarget);$("div.csenote").addClass("ui-corner-all");if(scrollTarget.find("div.csenote_new").css("display")==="block"){$("div.csenote").css({opacity:".5"})}}})}}function loadCaseNotes(panelTarget,id){$(panelTarget).find(".case_detail_panel").load("lib/php/data/cases_casenotes_load.php",{case_id:id,start:"0"},function(){var toolsHeight=$(panelTarget).find(".case_detail_nav li:first").outerHeight();var thisPanelHeight=$(panelTarget).find(".case_detail_nav").height();var caseNotesWindowHeight=thisPanelHeight-toolsHeight;$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:caseNotesWindowHeight});if(!$(".case_detail_panel_tools_right button.button1").length){$(".case_detail_panel_tools_right button.button3").button({icons:{primary:"fff-icon-printer"},text:true})}else{$(".case_detail_panel_tools_right button.button1").button({icons:{primary:"fff-icon-add"},text:true}).next().button({icons:{primary:"fff-icon-time"},text:true}).next().button({icons:{primary:"fff-icon-printer"},text:true})}var scrollTarget=$(panelTarget).find(".case_detail_panel_casenotes");scrollTarget.data("CaseNumber",id);$(scrollTarget).bind("scroll",function(){addMoreNotes(scrollTarget)});sizeCaseNotes($(panelTarget).find(".csenote"),$(panelTarget).find(" .case_detail_panel"));$("div.csenote").addClass("ui-corner-all")})}$("div.more").live("click",function(event){event.preventDefault();var cseNoteParent=$(this).closest(".csenote");var cseNoteParentMaxHeight=$(this).closest(".csenote").data("maxCaseNoteHeight");var cseNoteParentMinHeight=$(this).closest(".csenote").data("minCaseNoteHeight");if($(this).find("a").html()==="Less"){cseNoteParent.css({height:cseNoteParentMinHeight});$(this).find("a").html("More")}else{cseNoteParent.css({height:"auto"});$(this).find("a").html("Less")}});$("input.casenotes_search").live("focusin",function(){$(this).val("");$(this).css({color:"black"});$(this).next(".casenotes_search_clear").show()});$("input.casenotes_search").live("keyup",function(){var resultTarget=$(this).closest("div.case_detail_panel_tools").next();var search=$(this).val();var caseId=resultTarget.data("CaseNumber");if(search.length>2){resultTarget.unbind("scroll");resultTarget.load("lib/php/data/cases_casenotes_load.php",{case_id:caseId,search:search,update:"yes"},function(){resultTarget.scrollTop(0);if(search.length){resultTarget.highlight(search)}sizeCaseNotes($(".csenote"),resultTarget);if(resultTarget.hasClass("csenote_shadow")){resultTarget.removeClass("csenote_shadow")}$("div.csenote").addClass("ui-corner-all");resultTarget.bind("scroll.search",function(){if($(this).scrollTop()>0){$(this).addClass("csenote_shadow")}else{$(this).removeClass("csenote_shadow")}})})}});$(".casenotes_search_clear").live("click",function(){$(this).prev().val("Search Case Notes");$(this).prev().css({color:"#AAA"});var resultTarget=$(this).closest("div.case_detail_panel_tools").next();var thisCaseNumber=resultTarget.data("CaseNumber");resultTarget.load("lib/php/data/cases_casenotes_load.php",{case_id:thisCaseNumber,start:"0",update:"yes"},function(){resultTarget.scrollTop(0);sizeCaseNotes($(".csenote"),resultTarget);$("div.csenote").addClass("ui-corner-all");resultTarget.unbind("scroll.search");resultTarget.bind("scroll",function(){addMoreNotes(resultTarget)})});$(this).hide()});$(".case_detail_panel_tools_right button.button1").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var newNote=$(this).closest(".case_detail_panel_tools").siblings().find(".csenote_new");newNote.show();$(this).closest(".case_detail_panel_tools").siblings().find("textarea").TextAreaExpander(52,200).css({color:"#AAA"}).html("Describe what you did...").mouseenter(function(){$(this).focus().val("").css({color:"black"}).unbind("mouseenter")});$(this).closest(".case_detail_panel_tools").siblings().find("div.csenote").not("div.csenote_new").css({opacity:".5"});var thisDate=$("input.csenote_date_value").val();$("input.csenote_date_value").datepicker({dateFormat:"m/d/yy",showOn:"button",buttonText:thisDate,onSelect:function(dateText,inst){$(this).next().html(dateText)}});newNote.find(".csenote_action_submit").button({icons:{primary:"fff-icon-add"}}).next().button({icons:{primary:"fff-icon-cancel"},text:true})});$(".case_detail_panel_tools_right button.button2").live("click",function(){var caseName=$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title h2").html();var d=new Date;var startTime=d.getTime();$("#timer .timer_case_name").html(caseName);$.cookie("timer_status","on");$.cookie("timer_start_time",startTime);$.cookie("timer_case_name",caseName);var caseId=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").data("CaseNumber");$.cookie("timer_case_id",caseId);ccTimer(true,startTime);$("#timer").show();setDetailCss();var currentContentHeight=$("#content").height();$("#content").height(currentContentHeight-45)});$(".case_detail_panel_tools_right button.button3").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Casenotes: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())});$("button.csenote_action_cancel").live("click",function(event){event.preventDefault();var panelTarget=$(this).closest(".ui-tabs-panel");var id=$(this).closest(".case_detail_panel").data("CaseNumber");loadCaseNotes(panelTarget,id)});$("button.csenote_action_submit").live("click",function(event){event.preventDefault();var cseVals=$(this).closest("form").serializeArray();var thisForm=$(this).closest;var resultTarget=$(this).closest("div.case_detail_panel_casenotes");var thisCaseNumber=resultTarget.data("CaseNumber");var errString=validCaseNote(cseVals);if(errString.length){notify(errString,true)}else{$.post("lib/php/data/cases_casenotes_process.php",cseVals,function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);resultTarget.load("lib/php/data/cases_casenotes_load.php",{case_id:thisCaseNumber,start:"0",update:"yes"},function(){sizeCaseNotes($(".csenote"),resultTarget)})}})}});$("a.csenote_delete").live("click",function(event){event.preventDefault();var thisCseNote=$(this).closest(".csenote");var thisCseNoteId=thisCseNote.attr("id").split("_");var dialogWin=$('<div class=".dialog-casenote-delete" title="Delete this Case Note?">'+"This case note will be permanently deleted.  Are you sure?</div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/cases_casenotes_process.php",{query_type:"delete",csenote_casenote_id:thisCseNoteId[1]},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{thisCseNote.remove();notify(serverResponse.message)}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$("a.csenote_edit").live("click",function(event){event.preventDefault();if($(this).closest(".case_detail_panel_casenotes").find(".csenote_edit_submit").length){notify("Only one case note can be edited at a time",true);return false}var thisCseNote=$(this).closest(".csenote");var cseNoteId=thisCseNote.attr("id").split("_");if(thisCseNote.find("span.highlight").length){thisCseNote.find("span.highlight").contents().unwrap()}var txtVal=escapeHtml(thisCseNote.find("p.csenote_instance").html().br2nl());var timeVal=$(this).closest("div").children(".csenote_time").html();var hourVal;var minuteVal;if(timeVal.indexOf(".")===-1){hourVal="0";minuteVal=parseInt(timeVal)}else{var timeParts=timeVal.split(".");hourVal=timeParts[0];minuteVal=parseInt(timeParts[1])}var dateVal=$(this).closest("div").children(".csenote_date").html();var editNote=$(this).closest("div.csenote").siblings("div.csenote_new").eq(0).clone();thisCseNote.after(editNote);editNote.show();thisCseNote.hide();editNote.find(".csenote_bar").css({"background-color":"#FEBBBB"});editNote.find("textarea").html(txtVal).TextAreaExpander(52,200);editNote.find('select[name="csenote_hours"]').val(hourVal);editNote.find('select[name="csenote_minutes"]').val(minuteVal);editNote.find('input[name="query_type"]').val("modify");editNote.find("button.csenote_action_submit").html("Done").addClass("csenote_edit_submit").removeClass("csenote_action_submit");editNote.find("input.csenote_date_value").val(dateVal).datepicker({dateFormat:"m/d/yy",showOn:"button",buttonText:dateVal,onSelect:function(dateText){$(this).next().html(dateText)}});editNote.find("form").append('<input type="hidden" name="csenote_casenote_id" value="'+cseNoteId[1]+'">');editNote.find("button.csenote_action_cancel").unbind().bind("click",function(){editNote.remove();thisCseNote.show()});editNote.find("button.csenote_action_submit").unbind();editNote.find("button.csenote_edit_submit").bind("click",function(event){event.preventDefault();var cseVals=$(this).closest("form").serializeArray();var errString=validCaseNote(cseVals);if(errString.length){notify(errString,"wait")}else{$.post("lib/php/data/cases_casenotes_process.php",cseVals,function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{thisCseNote.find(".csenote_date").html(cseVals[0]["value"]);var txtFormat=cseVals[6]["value"].nl2br();thisCseNote.find("p.csenote_instance").html(txtFormat);if(cseVals[1]["value"]=="0"){thisCseNote.find(".csenote_time").html(cseVals[2]["value"]+" minutes")}else{thisCseNote.find(".csenote_time").html(cseVals[1]["value"]+"."+cseVals[2]["value"]+" hours")}notify(serverResponse.message);editNote.remove();thisCseNote.show()}})}})});$("a.csenote_print").live("click",function(e){e.preventDefault();elPrint($(this).closest("div.csenote"),$(this).closest(".ui-tabs-panel").find(".case_title").text()+" case")});$(".case_detail_nav #item1").live("click",function(){var panelTarget=$(this).closest(".ui-tabs-panel");var id=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");loadCaseNotes(panelTarget,id)});$(".case_detail_nav #item7").live("click",function(){var thisPanel=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");var caseId=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");var toolsHeight=$(this).outerHeight();var thisPanelHeight=$(this).closest(".case_detail_nav").height();var conflictsWindowHeight=thisPanelHeight-toolsHeight;thisPanel.load("lib/php/data/cases_conflicts_load.php",{case_id:caseId},function(data){$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:conflictsWindowHeight});$("div.case_detail_panel_tools_left").css({width:"70%"});$("div.case_detail_panel_tools_right").css({width:"30%"});$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}});$("button.conflicts_print").button({icons:{primary:"fff-icon-printer"},text:true}).click(function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Conflicts: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())})})});function sizeContacts(contacts,panelTarget){var windowHeight=panelTarget.height();var minContactHeight=panelTarget.height()*.4;contacts.not(".new_contact").each(function(){$(this).data("maxContactHeight",$(this).height());$(this).data("minContactHeight",minContactHeight);var notePercent=$(this).height()/windowHeight*100;if(notePercent>40){$(this).height(minContactHeight);$(this).css({overflow:"hidden"});$(this).append('<div class="contact_more"><a href="#">More</a></div>')}})}function doEditSelect(val,type){var phoneOptions=["mobile","home","office","fax"];var emailOptions=["work","home","other"];var selectOptions="";var i;if(type==="phone"){for(i=0;i<phoneOptions.length;i++){if(phoneOptions[i]===val){selectOptions+='<option value = "'+phoneOptions[i]+'" selected=selected>'+phoneOptions[i]+"</option>"}else{selectOptions+='<option value = "'+phoneOptions[i]+'">'+phoneOptions[i]+"</option>"}}selectOptions+='<a href="#" class="add_phone">Add Another</a>'}else{for(i=0;i<emailOptions.length;i++){if(emailOptions[i]===val){selectOptions+='<option value = "'+emailOptions[i]+'" selected=selected>'+emailOptions[i]+"</option>"}else{selectOptions+='<option value = "'+emailOptions[i]+'">'+emailOptions[i]+"</option>"}}}return selectOptions}var phoneWidget='<p class="contact_phone_group"><label>Phone</label><select name="phone_type" '+'class="contact_phone_type"><option value="mobile">mobile</option><option value="home">home</option>'+'<option value="office">office</option><option value="fax">fax</option><option value="other">other</option>'+'</select><input type="text" name="phone" class="contact_phone_value"><a href="#" class="add_phone">Add Another</a>';var emailWidget='<p class="contact_email_group"><label>Email</label><select name="email_type"'+'class="contact_email_type"><option value="work">work</option><option value="home">home</option>'+'<option value="other">other</option></select><input type="text" name="email" class="contact_email_value">'+'<a href="#" class="add_email">Add Another</a>';$(".case_detail_nav #item6").live("click",function(){var thisPanel=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");var caseId=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");var toolsHeight=$(this).outerHeight();var thisPanelHeight=$(this).closest(".case_detail_nav").height();var contactsWindowHeight=thisPanelHeight-toolsHeight;thisPanel.load("lib/php/data/cases_contacts_load.php",{case_id:caseId},function(){$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:contactsWindowHeight});$("div.case_detail_panel_tools_left").css({width:"30%"});$("div.case_detail_panel_tools_right").css({width:"70%"});$("button.new_contact").button({icons:{primary:"fff-icon-vcard-add"},text:true}).next().button({icons:{primary:"fff-icon-printer"},text:true});$("div.csenote").addClass("ui-corner-all");sizeContacts($(this).find(".contact"),thisPanel);$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}})})});$("div.contact_more").live("click",function(event){event.preventDefault();var contactParent=$(this).closest(".contact");var contactParentMaxHeight=$(this).closest(".contact").data("maxContactHeight");var contactParentMinHeight=$(this).closest(".contact").data("minContactHeight");if($(this).find("a").html()==="Less"){contactParent.css({height:contactParentMinHeight});$(this).find("a").html("More")}else{contactParent.css({height:contactParentMaxHeight});$(this).find("a").html("Less")}});$(".case_detail_panel_tools_right button.new_contact").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var addContactWidget=$(this).closest(".case_detail_panel_tools").siblings().find("div.new_contact");addContactWidget.show();$(this).closest(".case_detail_panel_tools").siblings().find("div.contact").not("div.csenote_new").css({opacity:".5"});addContactWidget.find('select[name = "contact_type"]').combobox();$(this).closest(".case_detail_panel_tools").siblings().find("span.contact_phone_widget").html(phoneWidget);$(this).closest(".case_detail_panel_tools").siblings().find("span.contact_email_widget").html(emailWidget);$(this).closest(".case_detail_panel_tools").siblings().find("button.contact_action_cancel").click(function(event){event.preventDefault();addContactWidget.find("form")[0].reset();addContactWidget.find("span.first_name_live").html("New Contact");addContactWidget.find("span.last_name_live").html("");addContactWidget.find("span.contact_type_live").html("");$(this).closest(".case_detail_panel_casenotes").find(".contact").css({opacity:"1"});$(this).closest(".csenote_new").hide();addContactWidget.find('select[name = "contact_type"]').combobox("destroy")});$(this).closest(".case_detail_panel_tools").siblings().find("button.contact_action_submit").click(function(event){event.preventDefault();var contactForm=$(this).closest("form");var contactVals=contactForm.serializeArray();var errString=validContact(contactForm);if(errString.length){notify(errString,true)}else{var phoneData={};contactForm.find("p.contact_phone_group").each(function(){var phoneKey=$(this).find("select.contact_phone_type").val();var phoneValue=$(this).find("input.contact_phone_value").val();if(phoneValue.length){phoneData[phoneKey]=phoneValue}});var phoneJson=JSON.stringify(phoneData);var emailData={};contactForm.find("p.contact_email_group").each(function(){var emailKey=$(this).find("select.contact_email_type").val();var emailValue=$(this).find("input.contact_email_value").val();if(emailValue.length){emailData[emailKey]=emailValue}});var emailJson=JSON.stringify(emailData);var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var target=$(this).closest(".case_detail_panel_casenotes");addContactWidget.find('select[name = "contact_type"]').combobox("destroy");$.post("lib/php/data/cases_contacts_process.php",{first_name:contactForm.find('input[name = "first_name"]').val(),last_name:contactForm.find('input[name = "last_name"]').val(),organization:contactForm.find('input[name = "organization"]').val(),contact_type:contactForm.find('select[name = "contact_type"]').val(),address:contactForm.find('textarea[name = "address"]').val(),city:contactForm.find('input[name = "city"]').val(),state:contactForm.find('select[name = "state"]').val(),zip:contactForm.find('input[name = "zip"]').val(),phone:phoneJson,email:emailJson,url:contactForm.find('input[name = "url"]').val(),notes:contactForm.find('textarea[name = "notes"]').val(),action:"add",case_id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);target.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:caseId});checkConflicts(caseId)}})}})});$(".case_detail_panel_tools_right button.contact_print").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Contacts: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())});$("#contact_first_name").live("keyup",function(){$(this).closest(".new_contact").find("span.first_name_live").html(escapeHtml($(this).val()))});$("#contact_last_name").live("keyup",function(){$(this).closest(".new_contact").find("span.last_name_live").html(escapeHtml($(this).val()))});$("#contact_type").live("change",function(){$(this).closest(".new_contact").find("span.contact_type_live").html(escapeHtml($(this).val()))});$("#contact_first_name").live("focus",function(){$(this).closest(".new_contact").find("span.first_name_live").html("");$("#contact_first_name").die("focus")});$("#contact_organization").live("focus",function(){if($("#contact_first_name").val()===""&&$("#contact_last_name").val()===""){$(this).keyup(function(){$(this).closest(".new_contact").find("span.first_name_live").html(escapeHtml($(this).val()))});$(this).focusout().die("keyup")}});$("input.contacts_search").live("focusin",function(){$(this).val("");$(this).css({color:"black"});$(this).next(".contacts_search_clear").show()});$("input.contacts_search").live("keyup",function(){var resultTarget=$(this).closest("div.case_detail_panel_tools").next();var search=$(this).val();var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");resultTarget.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:caseId,q:search},function(){resultTarget.scrollTop(0);if(search.length){resultTarget.highlight(search)}sizeContacts($(".contact"),resultTarget);if(resultTarget.hasClass("csenote_shadow")){resultTarget.removeClass("csenote_shadow")}$("div.contact").addClass("ui-corner-all");resultTarget.bind("scroll.search",function(){if($(this).scrollTop()>0){$(this).addClass("csenote_shadow")}else{$(this).removeClass("csenote_shadow")}})})});$(".contacts_search_clear").live("click",function(){$(this).prev().val("Search Contacts");$(this).prev().css({color:"#AAA"});var resultTarget=$(this).closest("div.case_detail_panel_tools").next();var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");resultTarget.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:caseId},function(){resultTarget.scrollTop(0);sizeContacts($(".contact"),resultTarget);$("div.csenote").addClass("ui-corner-all");resultTarget.unbind("scroll.search");resultTarget.bind("scroll",function(){addMoreNotes(resultTarget)})});$(this).hide()});$("a.contact_edit").live("click",function(event){event.preventDefault();if($(this).closest(".case_detail_panel_casenotes").find(".contact_edit_submit").length){notify("Only one contact can be edited at a time",true);return false}var thisContact=$(this).closest(".contact");var firstNameVal=thisContact.find(".cnt_first_name").html();var lastNameVal=thisContact.find(".cnt_last_name").html();var typeVal=thisContact.find(".cnt_type").html();var orgVal=thisContact.find(".cnt_organization").html();var addressVal=thisContact.find(".cnt_address").html();var cityVal=thisContact.find(".cnt_city").html();var stateVal=thisContact.find(".cnt_state").html();var zipVal=thisContact.find(".cnt_zip").html();var urlVal=thisContact.find(".cnt_url").html();var notesValRaw=thisContact.find(".cnt_notes").html();var notesVal;if(notesValRaw!==null){notesVal=notesValRaw.br2nl()}else{notesVal=""}var contactId=thisContact.attr("data-id");var editContact=$(this).closest("div.contact").siblings("div.new_contact").clone().addClass("contact_edit");thisContact.after(editContact);var editContactPosition=thisContact.offset().top;if(!firstNameVal&&!lastNameVal){editContact.find("span.first_name_live").html(orgVal)}else{editContact.find("span.first_name_live").html(firstNameVal);editContact.find("span.last_name_live").html(lastNameVal)}editContact.find("span.contact_type_live").html(typeVal);editContact.find('input[name = "first_name"]').val(firstNameVal);editContact.find('input[name = "last_name"]').val(lastNameVal);editContact.find('input[name = "organization"]').val(orgVal);editContact.find('select[name = "contact_type"]').val(typeVal);editContact.find('textarea[name = "address"]').html(addressVal);editContact.find('input[name = "city"]').val(cityVal);editContact.find('select[name = "state"]').val(stateVal);editContact.find('input[name = "zip"]').val(zipVal);editContact.find('input[name = "url"]').val(urlVal);editContact.find('textarea[name = "notes"]').val(notesVal);var phoneData={};thisContact.find("p.contact_phone_group").each(function(){var phoneKey=$(this).find("span.contact_phone_type").text().trim();var phoneValue=$(this).find("span.contact_phone_value").text().trim();phoneData[phoneKey]=phoneValue});var phoneForm="";var phoneSelects="";if($.isEmptyObject(phoneData)){phoneForm='<p class="contact_phone_group"><label>Phone</label><select name="phone_type"'+'class="contact_phone_type"><option value="mobile">mobile</option><option value="home">home</option>'+'<option value="office">office</option><option value="fax">fax</option></select>'+'<input type="text" name="phone" class="contact_phone_value">'}else{$.each(phoneData,function(key,value){var phoneOptions=doEditSelect(key,"phone");phoneForm+='<p class="contact_phone_group"><label>Phone</label><select name="phone_type"'+'class="contact_phone_type">"'+phoneOptions+'"</select><input type="text" name="phone"'+'class="contact_phone_value" value="'+value+'">'})}editContact.find("span.contact_phone_widget").html(phoneForm);editContact.find("span.contact_phone_widget").find(".contact_phone_group input").last().after('<a href="#" class="add_phone">Add Another</a>');var emailData={};thisContact.find("p.contact_email_group").each(function(){var emailKey=$(this).find("span.contact_email_type").text().trim();var emailValue=$(this).find("span.contact_email_value").text().trim();emailData[emailKey]=emailValue});var emailForm="";var emailSelects="";if($.isEmptyObject(emailData)){emailForm='<p class="contact_email_group"><label>Email</label><select name="email_type"'+'class="contact_email_type"><option value="work">work</option><option value="home">home</option>'+'<option value="other">other</option></select><input type="text" name="email" class="contact_email_value">'}else{$.each(emailData,function(key,value){var emailOptions=doEditSelect(key,"email");emailForm+='<p class="contact_email_group"><label>Email</label><select name="email_type" '+'class="contact_email_type">'+emailOptions+'</select><input type="text" name="email" '+'class="contact_email_value" value="'+value+'">'})}editContact.find("span.contact_email_widget").html(emailForm);editContact.find("span.contact_email_widget").find(".contact_email_group input").last().after('<a href="#" class="add_email">Add Another</a>');editContact.find(".csenote_bar").css({"background-color":"#FEBBBB"});editContact.find("button.contact_action_submit").html("Done").addClass("contact_edit_submit").removeClass("contact_action_submit");editContact.find("button.contact_action_cancel").addClass("contact_edit_cancel").removeClass("contact_action_cancel");editContact.find('select[name = "contact_type"]').combobox();editContact.show();thisContact.hide();editContact.find("button.contact_edit_cancel").click(function(event){event.preventDefault();editContact.hide().remove();thisContact.show()});editContact.find("button.contact_edit_submit").click(function(event){event.preventDefault();var contactForm=$(this).closest("form");var contactVals=contactForm.serializeArray();var errString=validContact(contactForm);if(errString.length){notify(errString,true)}else{var phoneData={};contactForm.find("p.contact_phone_group").each(function(){var phoneKey=$(this).find("select.contact_phone_type").val();var phoneValue=$(this).find("input.contact_phone_value").val();phoneData[phoneKey]=phoneValue});var phoneJson=JSON.stringify(phoneData);var emailData={};contactForm.find("p.contact_email_group").each(function(){var emailKey=$(this).find("select.contact_email_type").val();var emailValue=$(this).find("input.contact_email_value").val();emailData[emailKey]=emailValue});var emailJson=JSON.stringify(emailData);var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var target=$(this).closest(".case_detail_panel_casenotes");contactForm.find('select[name = "contact_type"]').combobox("destroy");$.post("lib/php/data/cases_contacts_process.php",{first_name:contactForm.find('input[name = "first_name"]').val(),last_name:contactForm.find('input[name = "last_name"]').val(),organization:contactForm.find('input[name = "organization"]').val(),contact_type:contactForm.find('select[name = "contact_type"]').val(),address:contactForm.find('textarea[name = "address"]').val(),city:contactForm.find('input[name = "city"]').val(),state:contactForm.find('select[name = "state"]').val(),zip:contactForm.find('input[name = "zip"]').val(),phone:phoneJson,email:emailJson,url:contactForm.find('input[name = "url"]').val(),notes:contactForm.find('textarea[name = "notes"]').val(),action:"edit",case_id:caseId,id:contactId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);target.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:caseId},function(){sizeContacts(target.find(".contact"),target);var editedContact=target.find('div.contact[data-id = "'+contactId+'"]');target.scrollTop(editedContact.offset().top);checkConflicts(caseId)})}})}})});$("a.contact_delete").live("click",function(event){event.preventDefault();var thisContact=$(this).closest(".contact");var thisContactId=thisContact.attr("data-id");var dialogWin=$('<div class=".dialog-casenote-delete" title="Delete this Contact?">This contact'+" will be permanently deleted.  Are you sure?</div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/cases_contacts_process.php",{action:"delete",id:thisContactId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);thisContact.remove()}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$(".add_email").live("click",function(event){event.preventDefault();$(this).closest("p").after(emailWidget);$(this).remove()});$(".add_phone").live("click",function(event){event.preventDefault();$(this).closest("p").after(phoneWidget);$(this).remove()});function createTrail(path){var pathArray=path.split("/");var pathString="";var pathS="";$.each(pathArray,function(i,v){pathS+="/"+v;var pathSa=pathS.substr(1);var pathItem='<a class="doc_trail_item" href="#" path="'+pathSa+'">'+escapeHtml(unescape(v))+"</a>/";pathString+=pathItem});return pathString}function createDragDrop(){$(".item, .folder").draggable("destroy");

$(".folder").droppable("destroy");$(".item").draggable({revert:"invalid",helper:"clone"});$(".folder").droppable({activeClass:"ui-state-highlight",drop:function(event,ui){var docType=null;if(ui.draggable.hasClass("folder")){docType="folder"}else{docType="item"}var caseId=ui.draggable.closest(".case_detail_panel").data("CaseNumber");$.post("lib/php/data/cases_documents_process.php",{action:"cut",item_id:ui.draggable.attr("data-id"),target_path:$(event.target).attr("path"),selection_path:ui.draggable.attr("path"),doc_type:docType,case_id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.wait){notify(serverResponse.message,true,"error")}else{notify(serverResponse.message);ui.draggable.fadeOut()}})}}).draggable({revert:"invalid",containment:"div.case_detail_panel_casenotes"})}function createTextEditor(target,action,permission,title,content,id,owner,locked){var editor='<div class="text_editor_bar" data-id="">'+'<div class="text_editor_title" tabindex="0">'+title+'</div><div class="text_editor_status"><span class= "status">Unchanged</span>'+'</div></div><textarea class="text_editor"></textarea>';target.html(editor);var ccdTitleArea=target.find(".text_editor_title");var ccdStatusArea=target.find(".text_editor_status");var ccdTitle=target.find(".text_editor_title").html();var caseId=target.closest(".case_detail_panel").data("CaseNumber");var currentPath=target.closest(".case_detail_panel").data("CurrentPath");var docIdArea=target.find(".text_editor_bar");var tools=target.siblings(".case_detail_panel_tools");if(currentPath==="Home"){currentPath=""}var arr=target.find(".text_editor").rte({css:["lib/javascripts/lwrte/default2.css"],width:900,height:400,controls_rte:rte_toolbar});if(action==="view"){arr[0].set_content(content);ccdTitleArea.html(escapeHtml(unescape(title)));docIdArea.attr("data-id",id)}if(permission==="no"&&owner!=="1"){$(arr[0].iframe_doc).keydown(function(event){return false});ccdStatusArea.html('<span class="readonly">Read Only</status>');target.find(".rte-toolbar a").not(".print").css({opacity:".3"});target.find(".rte-toolbar select").css({opacity:".3"})}if(owner==="1"){var permSelect='<select name="ccd_permission">';if(locked==="no"){permSelect+='<option value="no" selected=selected>Unlocked</option>'+'<option value="yes">Locked</option>'}else{permSelect+='<option value="no" >Unlocked</option><option value="yes"'+"selected=selected>Locked</option>"}permSelect+="</select>";ccdStatusArea.append(permSelect)}if(action==="new"){$.post("lib/php/data/cases_documents_process.php",{action:"new_ccd",ccd_name:escape(ccdTitle),local_file_name:"New Document.ccd",path:currentPath,case_id:caseId},function(data){var serverResponse=$.parseJSON(data);docIdArea.attr("data-id",serverResponse.ccd_id);ccdTitleArea.html(escapeHtml(unescape(serverResponse.ccd_title)))})}tools.find("button").hide();tools.find("input").hide();tools.siblings(".case_documents_submenu").hide();tools.find(".case_detail_panel_tools_right").append('<button class="closer">Close</button>');tools.find("button.closer").button({icons:{primary:"fff-icon-cross"},text:true});tools.find("button.closer").click(function(){var returnToFiles=function(){if(currentPath===""){target.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:currentPath},function(){tools.find("button").show();tools.find("input").show();tools.find(".documents_search_clear").hide();tools.find("button.closer").remove();tools.siblings(".case_documents_submenu").show();createDragDrop()})}else{target.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:currentPath,container:currentPath},function(){tools.find("button").show();tools.find("input").show();tools.find(".documents_search_clear").hide();tools.find("button.closer").remove();tools.siblings(".case_documents_submenu").show();createDragDrop()})}};if($(".text_editor").html()===""&&$(".text_editor_title").text()==="New Document"){var warning="It appears this document is empty. Do you want to save it anyway?";var dialogWin=$('<div class=".dialog-casenote-delete" title="Delete this Item?">'+warning+"</div>").dialog({autoOpen:true,resizable:false,modal:true,buttons:{Yes:function(){dialogWin.dialog("destroy");returnToFiles()},No:function(){var itemId=$(".text_editor_bar").attr("data-id");$.post("lib/php/data/cases_documents_process.php",{action:"delete",item_id:itemId,doc_type:"ccd"},function(data){var serverResponse=$.parseJSON(data);notify(serverResponse.message);dialogWin.dialog("destroy")});$(this).dialog("destroy");returnToFiles()}}})}else{returnToFiles()}});if(permission==="yes"){ccdTitleArea.mouseenter(function(){$(this).css({color:"red"})}).click(function(){$(this).html('<input type="text" value="" />');$(this).find("input").val(escapeHtml(unescape(ccdTitle))).focus().select()}).bind("focusout keyup",function(e){if(e.type==="focusout"||e.which===13){ccdTitle=escape($(this).find("input").val());if(ccdTitle===""||ccdTitle==="\n"){notify("Please give your document a title.",true);$(this).find("input").addClass("ui-state-error").focus();return false}else{$(this).html(escapeHtml(unescape(ccdTitle)));$(this).css({color:"black"});var getText=arr[0].get_content();$.post("lib/php/data/cases_documents_process.php",{action:"update_ccd",ccd_name:ccdTitle,ccd_id:docIdArea.attr("data-id"),ccd_text:getText},function(data){var serverResponse=$.parseJSON(data);notify(serverResponse.message)})}}}).mouseleave(function(){$(this).css({color:"black"})});var lastText="";var autoSave=function(lastText,arr){var text=arr[0].get_content();var status="Saving...";if(text!==lastText){ccdStatusArea.find("span.status").html(status);$.post("lib/php/data/cases_documents_process.php",{action:"update_ccd",ccd_name:ccdTitleArea.html(),ccd_id:docIdArea.attr("data-id"),ccd_text:text},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error){ccdStatusArea.find("span.status").html(serverResponse.message)}else{ccdTitleArea.html(serverResponse.ccd_title);ccdStatusArea.find("span.status").html(serverResponse.message)}});lastText=text}var t=setTimeout(function(){autoSave(lastText,arr)},3e3)};autoSave(lastText,arr)}}function clearSearchBox(el){el.closest(".case_detail_panel").find("input.documents_search").val("Search Titles").css({color:"#AAA"});el.closest(".case_detail_panel").find(".documents_search_clear").hide();el.closest(".case_detail_panel").find(".case_documents_submenu").show()}function openItem(el,itemId,docType,caseId,path,pathDisplay){if($(el).hasClass("folder")){if($(el).hasClass(".ui-draggable-dragging")){return}$(el).closest(".case_detail_panel_casenotes").load("lib/php/data/cases_documents_load.php",{id:caseId,container:path,path:path,update:"y"},function(){var pathString=createTrail(path);pathDisplay.html(pathString);pathDisplay.find('a[path="'+path+'"]').addClass("active");createDragDrop();$(this).closest(".case_detail_panel").data("CurrentPath",path);clearSearchBox($(this));$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}})})}else if($(el).hasClass("url")){if($(el).hasClass(".ui-draggable-dragging")){return}$.post("lib/php/data/cases_documents_process.php",{action:"open",item_id:itemId,doc_type:"document"},function(data){var serverResponse=$.parseJSON(data);window.open(serverResponse.target_url,"_blank")})}else if($(el).hasClass("ccd")){if($(el).hasClass(".ui-draggable-dragging")){return}$.post("lib/php/data/cases_documents_process.php",{action:"open",item_id:itemId,doc_type:"document"},function(data){var serverResponse=$.parseJSON(data);var target=$(el).closest(".case_detail_panel_casenotes");createTextEditor(target,"view",serverResponse.ccd_permissions,serverResponse.ccd_title,serverResponse.ccd_content,serverResponse.ccd_id,serverResponse.ccd_owner,serverResponse.ccd_locked)})}else if($(el).hasClass("pdf")){if(Object.create){$("#pdf-viewer").show();$("#frme").attr("src","lib/javascripts/pdfjs/web/viewer.html?item_id="+itemId);$("#pdf-viewer").click(function(){$("#frme").attr("src","");$(this).hide()});$("body").bind("keyup.pdfViewer",function(e){if(e.keyCode===27){$("#frme").attr("src","");$("#pdf-viewer").hide()}})}else{$.download("lib/php/data/cases_documents_process.php",{item_id:itemId,action:"open",doc_type:docType})}}else{if($(el).hasClass(".ui-draggable-dragging")){return}$.download("lib/php/data/cases_documents_process.php",{item_id:itemId,action:"open",doc_type:docType})}}$(".case_detail_nav #item3").live("click",function(){var thisPanel=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");var caseId=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");var toolsHeight=$(this).outerHeight();var thisPanelHeight=$(this).closest(".case_detail_nav").height();var documentsWindowHeight=thisPanelHeight-toolsHeight;thisPanel.data("CurrentPath","Home");thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId},function(){$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:documentsWindowHeight});$("div.case_detail_panel_tools_left").css({width:"20%"});$("div.case_detail_panel_tools_right").css({width:"80%"});$("div.case_detail_panel_tools").css({"border-bottom":"1px solid #AAA","margin-bottom":"10px"});$(this).find("button.doc_new_doc").button({icons:{primary:"fff-icon-page-add"},text:true});$(this).find("button.doc_new_folder").button({icons:{primary:"fff-icon-folder-add"},text:true});$(this).find("button.doc_upload").button({icons:{primary:"fff-icon-page-white-get"},text:true});$(this).find(".documents_view_chooser").buttonset();$(this).find(".radio_toggle_grid").button({icons:{primary:"fff-icon-application-view-icons"},text:true});$(this).find(".radio_toggle_list").button({icons:{primary:"fff-icon-application-view-list"},text:true}).next().addClass("buttonset-inactive");if(!$.cookie("cc_doc_view")||$.cookie("cc_doc_view")==="grid"){$(this).find(".radio_toggle_grid").next().removeClass("buttonset-inactive");$(this).find(".radio_toggle_list").next().addClass("buttonset-inactive")}else{$(this).find(".radio_toggle_list").next().removeClass("buttonset-inactive");$(this).find(".radio_toggle_grid").next().addClass("buttonset-inactive")}$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}});createDragDrop()});$(".doc_item").contextMenu({menu:"docMenu"},function(action,el,pos){var itemId=$(el).attr("data-id");var docType=null;var caseId=$(el).closest(".case_detail_panel").data("CaseNumber");var docName=$(el).find("p").html();var pathDisplay=$(el).closest(".case_detail_panel_casenotes").siblings(".case_detail_panel_tools").find(".path_display");var path;if($(el).hasClass("folder")){docType="folder";path=$(el).attr("path")}else{docType="document";path=""}switch(action){case"open":openItem(el,itemId,docType,caseId,path,pathDisplay);break;case"cut":$(el).css({opacity:".5"});var cutData=new Array(itemId,docType,path,caseId);$(el).closest(".case_detail_panel_casenotes").data("cutValue",cutData);$("div.case_detail_panel_casenotes").contextMenu({menu:"docMenu_copy_paste"},function(action,el,pos){if(action==="paste"){var caseId=el.data("cutValue")[3];var docType=el.data("cutValue")[1];var targetPath=el.closest(".case_detail_panel").data("CurrentPath");if(targetPath==="Home"){targetPath=""}var itemId=el.data("cutValue")[0];var selectionPath=el.data("cutValue")[2];$.post("lib/php/data/cases_documents_process.php",{action:"cut",item_id:itemId,target_path:targetPath,selection_path:selectionPath,doc_type:docType,case_id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error){notify(serverResponse.message,true,"error")}else{notify(serverResponse.message)}el.closest(".case_detail_panel_casenotes").load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:targetPath,container:targetPath},function(){el.destroyContextMenu();createDragDrop()})})}});break;case"copy":if(docType==="folder"){notify("Sorry, copying of folders is not supported.",true)}else{$(el).css({border:"1px solid #AAA"});var copyData=new Array(itemId,docType,path,caseId);$(el).closest(".case_detail_panel_casenotes").data("copyValue",copyData);$("div.case_detail_panel_casenotes").contextMenu({menu:"docMenu_copy_paste"},function(action,el,pos){if(action==="paste"){var caseId=el.data("copyValue")[3];var docType=el.data("copyValue")[1];var selectionPath=el.data("copyValue")[2];var targetPath=el.closest(".case_detail_panel").data("CurrentPath");if(targetPath==="Home"){targetPath=""}var itemId=el.data("copyValue")[0];$.post("lib/php/data/cases_documents_process.php",{action:"copy",item_id:itemId,target_path:targetPath,doc_type:docType,case_id:caseId},function(data){var serverResponse=$.parseJSON(data);notify(serverResponse.message);el.closest(".case_detail_panel_casenotes").load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:targetPath,container:targetPath},function(){el.destroyContextMenu()})})}})}break;case"rename":var textVal=$(el).find("p").html(),submitChange=function(cb){var newVal=escape($.trim($(el).find("textarea").val()));if(newVal===""){return}$.post("lib/php/data/cases_documents_process.php",{action:"rename",new_name:newVal,item_id:itemId,doc_type:docType,path:path,case_id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error){notify(serverResponse.message);return}else{$(el).find("textarea").hide();$(el).find("p").html(escapeHtml(unescape(newVal)));$(el).attr("path",serverResponse.newPath);$(el).find("p").show()}notify(serverResponse.message);cb()})};$(el).find("p").hide();if($(el).find("textarea").length<1){$(el).find("p").after("<br /><textarea>"+textVal+"</textarea>")}else{$(el).find("textarea").show().val(textVal)}$(el).find("textarea").addClass("user_input").focus().select().blur(function(e){submitChange(function(){$(el).find("textarea").hide();$(el).find("p").show();$(el).find("textarea").unbind("blur keypress")})}).click(function(event){event.stopPropagation()}).keypress(function(e){e.stopPropagation();if(e.which===13){submitChange(function(){$(el).find("textarea").unbind("keypress blur")})}});break;case"delete":var warning=null;if($(el).hasClass("folder")){warning="This folder and all of its contents will be permanently "+"deleted from the server."+" Are you sure?"}else{warning="This item will be permanently deleted from the server.  Are you sure?"}var dialogWin=$('<div class=".dialog-casenote-delete" title="Delete this Item?">'+warning+"</div>").dialog({autoOpen:true,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/cases_documents_process.php",{action:"delete",item_id:itemId,doc_type:docType,path:path,case_id:caseId},function(data){var serverResponse=$.parseJSON(data);notify(serverResponse.message);$(el).remove();dialogWin.dialog("destroy")})},No:function(){$(this).dialog("destroy")}}});break;case"properties":$(el).css({border:"1px solid #AAA"}).next(".doc_properties").addClass("ui-corner-all").css({top:"20%",left:"30%"}).show().focus().focusout(function(){$(this).hide();$(el).css({border:"0px"})});break}});$("div.doc_item").live("mouseenter",function(event){$(this).closest("div").css({height:"auto",overflow:"auto"})});$("div.doc_item").live("mouseleave",function(event){$(this).closest("div").css({height:"120px",overflow:"hidden"})})});$(".doc_item").live("click",function(event){event.preventDefault();var path=$(this).attr("path");var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var pathDisplay=$(this).closest(".case_detail_panel_casenotes").siblings(".case_documents_submenu").find(".path_display");var el=$(this);var itemId=el.attr("data-id");var docType="document";openItem(el,itemId,docType,caseId,path,pathDisplay)});$("button.doc_new_doc").live("click",function(){var target=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");createTextEditor(target,"new","yes","New Document",null,null,"1","yes")});$("button.doc_new_folder").live("click",function(){var target=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");if($("span.docs_empty")){$("span.docs_empty").remove()}if($.cookie("cc_doc_view")==="list"){target.find("tbody").prepend('<tr class="doc_item folder" path="" data-id="">'+'<td width="10%"><img src="html/ico/folder.png"></td>'+'<td><p><textarea rows="1" id="new_folder_name">New Folder</textarea></p></td><td></td><td></td></tr>')}else{target.prepend('<div class="doc_item folder" path="" data-id=""><img src="html/ico/folder.png">'+'<p><textarea id="new_folder_name">New Folder</textarea></p></div>')}$("#new_folder_name").select();$("#new_folder_name").addClass("user_input").mouseenter(function(){$(this).val("").focus().css({"background-color":"white"})}).bind("blur keyup",function(e){if(e.type==="blur"||e.which===13){e.preventDefault();var container=$(this).closest(".case_detail_panel_casenotes").siblings(".case_documents_submenu").find("a.active").attr("path");var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var newName=$("#new_folder_name").val();if(newName.indexOf("/")!==-1){notify("Sorry, folder names cannot contain a foward slash.",true);return false}else if(newName==="\n"){notify("Please provde a name for your folder.",true);return false}else{var newFolder=null;if(container===""||typeof container==="undefined"){newFolder=escape($.trim(newName.replace(/[\n\r]$/,"")))}else{newFolder=container+"/"+escape($.trim(newName.replace(/[\n\r]$/,"")))}$.post("lib/php/data/cases_documents_process.php",{case_id:caseId,container:container,new_folder:newFolder,action:"newfolder"},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{if($.cookie("cc_doc_view")==="list"){$("#new_folder_name").closest("tr").find("img").wrap('<a href="#" />');$("#new_folder_name").closest("tr").attr({path:newFolder,"data-id":serverResponse.id}).droppable()}else{$("#new_folder_name").parent().siblings("img").wrap('<a href="#" />');$("#new_folder_name").closest(".folder").attr({path:newFolder,"data-id":serverResponse.id}).droppable()}$("#new_folder_name").closest("p").html(escapeHtml(newName));createDragDrop();notify(serverResponse.message)}})}}})});$("button.doc_upload").live("click",function(){var thisPanel=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");if($("span.docs_empty")){$("span.docs_empty").remove()}var activeDirectory=$(this).parent().siblings().find("a.active").text();if(activeDirectory===""){activeDirectory="Home"}var currentPath=$(this).closest(".case_detail_panel").data("CurrentPath");if(currentPath==="Home"){currentPath=""}$(document).find(".upload_dialog").dialog({height:500,width:500,modal:true,title:"Upload into "+escapeHtml(activeDirectory)+" folder:",open:function(){$(this).find("div.upload_dialog_url").show();$(this).find("div.upload_dialog_file").show();$(this).find("div.upload_url_form").hide()},close:function(){$(this).dialog("destroy")}});var uploader=new qq.FileUploader({element:$(".upload_dialog_file")[0],action:"lib/php/utilities/file_upload.php",params:{path:currentPath,case_id:caseId},onComplete:function(){thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:currentPath,container:currentPath},function(){createDragDrop()})}});$("div.qq-upload-button").addClass("ui-corner-all").click(function(){$(this).closest(".upload_dialog_file").siblings("div.upload_dialog_url").hide()});$(".upload_url_button").mouseenter(function(){$(this).addClass("qq-upload-button-hover")}).mouseleave(function(){$(this).removeClass("qq-upload-button-hover")}).click(function(){$(this).siblings(".upload_url_form").show();$(this).parents(".upload_dialog_url").siblings(".upload_dialog_file").hide()});$("button.upload_url_submit").unbind("click").click(function(){var url=$(this).siblings("input.url_upload").val();var urlName=$(this).siblings("input.url_upload_name").val();if(isUrl(url)===false){$(document).find("p.upload_url_form_error_url").html("Sorry, your URL is invalid.  It must begin with http://, https:// or ftp://");$(this).siblings("input.url_upload").focus(function(){$(document).find("p.upload_url_form_error_url").html("")});return false}else if(urlName===""){$(document).find("p.upload_url_form_error_name").html("Please give this URL a title.");$(this).siblings("input.url_upload_name").focus(function(){$(document).find("p.upload_url_form_error_name").html("")});return false}else{$.post("lib/php/data/cases_documents_process.php",{url_name:urlName,url:url,case_id:caseId,path:currentPath,action:"add_url"},function(data){var serverResponse=$.parseJSON(data);$(".upload_dialog").find("p.upload_url_notify").show().html(serverResponse.message).fadeOut("slow",function(){$(this).html("")});$(".upload_dialog").find("input").val("");thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:currentPath,container:currentPath},function(){})})}})});$("a.doc_trail_home").live("click",function(event){event.preventDefault();var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var thisPanel=$(this).closest(".case_documents_submenu").siblings(".case_detail_panel_casenotes");$(this).closest(".case_detail_panel").data("CurrentPath","Home");thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes"},function(){$(this).siblings(".case_documents_submenu").find(".path_display").html("");createDragDrop();clearSearchBox($(this))})});$("a.doc_trail_item").live("click",function(event){event.preventDefault();var container=$(this).html();var path=$(this).attr("path");var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");$(this).closest(".case_detail_panel").data("CurrentPath",path);var thisPanel=$(this).closest(".case_documents_submenu").siblings(".case_detail_panel_casenotes");var pathDisplay=$(this).parent();thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:path,container:path},function(){$(this).siblings(".case_detail_panel_tools").find(".path_display").html("");var pathString=createTrail(path);pathDisplay.html(pathString);pathDisplay.find('a[path="'+path+'"]').addClass("active");$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}});createDragDrop()})});$('select[name="ccd_permission"]').live("change",function(){var lockStatus=$(this).val();var ccdId=$(this).closest(".text_editor_bar").attr("data-id");$.post("lib/php/data/cases_documents_process.php",{action:"change_ccd_permissions",ccd_id:ccdId,ccd_lock:lockStatus},function(data){var serverResponse=$.parseJSON(data);notify(serverResponse.message)})});$("input.documents_search").live("focusin",function(){$(this).val("");$(this).css({color:"black"});$(this).next(".documents_search_clear").show()});$("input.documents_search").live("keyup",function(){if($(this).val()!==""){var resultTarget=$(this).closest("div.case_detail_panel_tools").siblings(".case_detail_panel_casenotes");var search=$(this).val();var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");$(this).closest(".case_detail_panel_tools").siblings(".case_documents_submenu").hide();resultTarget.load("lib/php/data/cases_documents_load.php",{id:caseId,search:search,update:"yes"},function(){resultTarget.scrollTop(0);if(search.length){resultTarget.highlight(search);$("thead").removeHighlight()}})}else{$(".documents_search_clear").trigger("click")}});$(".documents_search_clear").live("click",function(){$(this).prev().val("Search Titles");$(this).prev().css({color:"#AAA"});$(this).prev().blur();$(this).closest(".case_detail_panel").find(".doc_trail_home").trigger("click");$(this).hide();$(this).closest(".case_detail_panel_tools").siblings(".case_documents_submenu").show()});$(".radio_toggle_grid").live("click",function(){var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var thisPanel=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");var currentPath=$(this).closest(".case_detail_panel").data("CurrentPath");var sendPath;if(currentPath==="Home"){sendPath=""}else{sendPath=currentPath}var clickedButton=$(this);$.cookie("cc_doc_view","grid");thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId,update:"yes",path:sendPath,container:sendPath},function(){createDragDrop();clearSearchBox($(this));clickedButton.next().toggleClass("buttonset-inactive");clickedButton.siblings("input").next().toggleClass("buttonset-inactive")})});$(".radio_toggle_list").live("click",function(){var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var thisPanel=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");var currentPath=$(this).closest(".case_detail_panel").data("CurrentPath");var sendPath;if(currentPath==="Home"){sendPath=""}else{sendPath=currentPath}var clickedButton=$(this);$.cookie("cc_doc_view","list");thisPanel.load("lib/php/data/cases_documents_load.php",{id:caseId,list_view:"yes",update:"yes",path:sendPath,container:sendPath},function(){createDragDrop();clearSearchBox($(this));clickedButton.next().toggleClass("buttonset-inactive");clickedButton.prev().toggleClass("buttonset-inactive")})});$(".case_detail_nav #item4").live("click",function(){var thisPanel=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");var caseId=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");var toolsHeight=$(this).outerHeight();var thisPanelHeight=$(this).closest(".case_detail_nav").height();var eventsWindowHeight=thisPanelHeight-toolsHeight;thisPanel.load("lib/php/data/cases_events_load.php",{case_id:caseId},function(){$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:eventsWindowHeight});$("div.case_detail_panel_tools_left").css({width:"30%"});$("div.case_detail_panel_tools_right").css({width:"70%"});$("button.new_event").button({icons:{primary:"fff-icon-calendar-add"},text:true}).next().button({icons:{primary:"fff-icon-printer"},text:true});$("div.csenote").addClass("ui-corner-all");$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow")}})})});$(".case_detail_panel_tools_right button.new_event").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var addEventWidget=$(this).closest(".case_detail_panel_tools").siblings().find("div.new_event");addEventWidget.show();$(this).closest(".case_detail_panel_tools").siblings().find("div.event").not("div.csenote_new").css({opacity:".5"});addEventWidget.find('input[name="start"]').datetimepicker({ampm:true,stepHours:1,stepMinute:5,hour:9,minute:0,onSelect:function(dateText,inst){addEventWidget.find('input[name="end"]').datetimepicker("setDate",dateText)}});addEventWidget.find('input[name="end"]').datetimepicker({ampm:true,stepHours:1,stepMinute:5,hour:9,minute:0});addEventWidget.find('select[name="responsibles"]').chosen();$(this).closest(".case_detail_panel_tools").siblings().find("button.event_action_cancel").click(function(event){event.preventDefault();addEventWidget.find("form")[0].reset();addEventWidget.find("span.event_name_live").html("New Event");addEventWidget.find("select option").filter(function(){return this.text==="You"}).attr("selected",true);addEventWidget.find("select").trigger("liszt:updated");$(this).closest(".case_detail_panel_casenotes").find(".event").css({opacity:"1"});$(this).closest(".new_event").hide()});$(this).closest(".case_detail_panel_tools").siblings().find("button.event_action_submit").click(function(event){event.preventDefault();var eventForm=$(this).closest("form");var eventVals=eventForm.serializeArray();var resps=eventForm.find('select[name="responsibles"]').val();var resps_obj=$.extend({},resps);eventVals.unshift(resps_obj);var errString=validEvent(eventVals);if(errString.length){notify(errString,true)}else{var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var target=$(this).closest(".case_detail_panel_casenotes");var allDay=false;if(eventForm.find('input[name = "all_day"]').is(":checked")){allDay=true}$.post("lib/php/data/cases_events_process.php",{task:eventForm.find('input[name = "task"]').val(),where:eventForm.find('input[name = "where"]').val(),start:eventForm.find('input[name = "start"]').val(),end:eventForm.find('input[name = "end"]').val(),all_day:allDay,notes:eventForm.find('textarea[name = "notes"]').val(),responsibles:resps,action:"add",case_id:caseId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);target.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:caseId})}})}})});$('input[name="task"]').live("keyup",function(){$(this).closest(".new_event").find("span.event_name_live").html(escapeHtml($(this).val()))});$("input.events_search").live("focusin",function(){$(this).val("");$(this).css({color:"black"});$(this).next(".events_search_clear").show()});$("input.events_search").live("keyup",function(){var resultTarget=$(this).closest("div.case_detail_panel_tools").next();var search=$(this).val();var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");resultTarget.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:caseId,q:search},function(){resultTarget.scrollTop(0);if(search.length){resultTarget.highlight(search)}if(resultTarget.hasClass("csenote_shadow")){resultTarget.removeClass("csenote_shadow")}$("div.event").addClass("ui-corner-all");resultTarget.bind("scroll.search",function(){if($(this).scrollTop()>0){$(this).addClass("csenote_shadow")}else{$(this).removeClass("csenote_shadow")}})})});$(".events_search_clear").live("click",function(){$(this).prev().val("Search Events");$(this).prev().css({color:"#AAA"});var resultTarget=$(this).closest("div.case_detail_panel_tools").next();var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");resultTarget.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:caseId},function(){resultTarget.scrollTop(0);$("div.event").addClass("ui-corner-all")});$(this).hide()});$("a.event_delete").live("click",function(event){event.preventDefault();var thisEvent=$(this).closest(".event");var thisEventId=thisEvent.attr("data-id");var dialogWin=$('<div class=".dialog-casenote-delete" title="Delete this Event?">This event'+" will be permanently deleted.  Are you sure?</div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/cases_events_process.php",{action:"delete",event_id:thisEventId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);thisEvent.remove()}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$(".case_detail_panel_tools_right button.events_print").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Case Data: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())});$("a.event_edit").live("click",function(event){
event.preventDefault();if($(this).closest(".case_detail_panel_casenotes").find(".event_edit_submit").length){notify("Only one event can be edited at a time",true);return false}var thisEvent=$(this).closest(".event");var eventId=thisEvent.attr("data-id");var allDayVal;var taskVal=thisEvent.find("span.event_task_title").html();var startVal=thisEvent.find("span.event_start").html();var endVal=thisEvent.find("span.event_end").html();var locationVal=thisEvent.find("span.event_location").html();var notesVal=thisEvent.find("span.event_notes").html();if(thisEvent.find("span.event_all_day").length){allDayVal="on"}var usersArray=[];thisEvent.find("span.user_identifier").each(function(){usersArray.push($(this).attr("data"))});var editEvent=$(this).closest("div.event").siblings("div.new_event").clone().addClass("event_edit");thisEvent.after(editEvent);var editEventPosition=thisEvent.offset().top;editEvent.find("span.event_name_live").html(taskVal);editEvent.find('input[name="task"]').val(taskVal);editEvent.find('input[name="where"]').val(locationVal);editEvent.find('input[name="end"]').val(endVal);editEvent.find('textarea[name="notes"]').val(notesVal);editEvent.find('select[name="responsibles"]').val(usersArray);var editDateTimeStart=editEvent.find('input[name="start"]').datetimepicker({ampm:true,stepHours:1,stepMinute:5});editDateTimeStart.datetimepicker("setDate",new Date(startVal));var editDateTimeEnd=editEvent.find('input[name="end"]').datetimepicker({ampm:true,stepHours:1,stepMinute:5});editDateTimeEnd.datetimepicker("setDate",new Date(endVal));editEvent.find('select[name="responsibles"]').chosen();editEvent.find("div.chzn-container, div.chzn-drop").css({width:"150px"});editEvent.find(".csenote_bar").css({"background-color":"#FEBBBB"});editEvent.find("button.event_action_submit").html("Done").addClass("event_edit_submit").removeClass("event_action_submit");editEvent.find("button.event_action_cancel").addClass("event_edit_cancel").removeClass("event_action_cancel");editEvent.show();thisEvent.hide();editEvent.find("button.event_edit_cancel").click(function(event){event.preventDefault();editEvent.hide().remove();thisEvent.show()});editEvent.find("button.event_edit_submit").click(function(event){event.preventDefault();var eventForm=$(this).closest("form");var eventVals=eventForm.serializeArray();var resps=editEvent.find('select[name="responsibles"]').val();var resps_obj=$.extend({},resps);eventVals.unshift(resps_obj);var errString=validEvent(eventVals);if(errString.length){notify(errString,true)}else{var caseId=$(this).closest(".case_detail_panel").data("CaseNumber");var target=$(this).closest(".case_detail_panel_casenotes");$.post("lib/php/data/cases_events_process.php",{task:eventForm.find('input[name = "task"]').val(),where:eventForm.find('input[name = "where"]').val(),start:eventForm.find('input[name = "start"]').val(),end:eventForm.find('input[name = "end"]').val(),all_day:eventForm.find('input[name = "all_day"]').val(),notes:eventForm.find('textarea[name = "notes"]').val(),responsibles:resps,action:"edit",case_id:caseId,event_id:eventId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);target.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:caseId},function(){var editedEvent=target.find('div.contact[data-id = "'+eventId+'"]');target.scrollTop(editEventPosition)})}})}})});function addMoreMessages(scrollTarget,view,caseId){var scrollAmount=scrollTarget[0].scrollTop;var scrollHeight=scrollTarget[0].scrollHeight;var scrollPercent=scrollAmount/(scrollHeight-scrollTarget.height())*100;var startNum;if(scrollPercent>70){if(typeof scrollTarget.data("startVal")==="undefined"){startNum=20;scrollTarget.data("startVal",startNum)}else{startNum=scrollTarget.data("startVal")+parseInt(20);scrollTarget.data("startVal",startNum)}if(scrollTarget.data("searchOn")==="y"){$.post("lib/php/data/cases_messages_load.php",{type:view,start:scrollTarget.data("startVal"),s:scrollTarget.data("searchTerm"),case_id:caseId,update:"y"},function(data){var t=$(data).find("div").length;if(t===0){return false}else{scrollTarget.append(data);layoutMessages();scrollTarget.highlight(scrollTarget.data("searchTerm"))}})}else{$.post("lib/php/data/cases_messages_load.php",{type:view,start:scrollTarget.data("startVal"),case_id:caseId,update:"y"},function(data){var t=$(data).find("div").length;if(t===0){return false}else{scrollTarget.append(data);layoutMessages()}})}}}function checkOverflow(target){var el=target[0];var curOverflow=el.style.overflow;if(!curOverflow||curOverflow==="visible"){el.style.overflow="hidden"}var isOverflowing=el.clientWidth<el.scrollWidth||el.clientHeight<el.scrollHeight;el.style.overflow=curOverflow;return isOverflowing}function layoutMessages(){var oFlow=null;$("p.tos").each(function(){if(!$(this).next("p").hasClass("msg_to_more")){oFlow=checkOverflow($(this));if(oFlow===true){$(this).css({overflowY:"hidden"});$(this).after('<p class="msg_to_more ex_tos"><a href="#">and others</a></p>')}}});$("p.ccs").each(function(){if(!$(this).next("p").hasClass("msg_to_more")){oFlow=checkOverflow($(this));if(oFlow===true){$(this).css({overflowY:"hidden"});$(this).after('<p class="msg_to_more"><a href="#">and others</a></p>')}}});$("div.msg").addClass("ui-corner-all");$("div.msg_read").css({opacity:".5"})}$(".case_detail_nav #item5").live("click",function(){var caseId=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");var thisPanel=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");var scrollTarget=thisPanel.find(".case_detail_panel_casenotes");var toolsHeight=$(this).outerHeight();var thisPanelHeight=$(this).closest(".case_detail_nav").height();var caseNotesWindowHeight=thisPanelHeight-toolsHeight;thisPanel.load("lib/php/data/cases_messages_load.php",{type:"main",case_id:caseId,start:"0"},function(){$("div.case_detail_panel_tools").css({height:toolsHeight});$("div.case_detail_panel_casenotes").css({height:caseNotesWindowHeight});$("div.case_detail_panel_tools_left").css({width:"30%"});$("div.case_detail_panel_tools_right").css({width:"70%"});$("button.cse_new_msg").button({icons:{primary:"fff-icon-email-go"},text:true}).click(function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").load("lib/php/data/cases_messages_load.php #msg_new",{new_message:"y",case_id:caseId},function(){$(this).unbind("scroll.msg");if($(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}var newMsg=$("div#msg_new");newMsg.show();newMsg.find('select[name = "new_tos[]"], select[name = "new_ccs[]"], select[name = "new_file_msg"]').chosen();$("#msg_new_button_cancel").click(function(event){event.preventDefault();$("#new_msg_form")[0].reset();$(this).closest(".case_detail_panel").siblings(".case_detail_nav").find("li#item5").trigger("click");$(this).bind("scroll.msg");notify("New message cancelled")});$("#msg_new_button_submit").click(function(event){event.preventDefault();var msgVals=$("#new_msg_form").serializeArray();var target=$(this).closest(".case_detail_panel").siblings(".case_detail_nav").find("li#item5");if($('select[name="new_tos"]').val()===null){notify("<p>You must select at least one recipient</p>");return false}else{$.post("lib/php/data/messages_process.php",msgVals,function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{$("#new_msg_form")[0].reset();target.trigger("click");notify("Message sent");$(this).bind("scroll.msg")}})}})})});layoutMessages();thisPanel.data("searchOn","n");$(this).children(".case_detail_panel_casenotes").bind("scroll.msg",function(){var scrollAmount=$(this).scrollTop();if(scrollAmount===0&&$(this).hasClass("csenote_shadow")){$(this).removeClass("csenote_shadow")}else{$(this).addClass("csenote_shadow");var view=null;if(thisPanel.data("searchOn")==="y"){view="search"}else{view="main"}addMoreMessages($(this),view,caseId)}})})});$("div.msg_bar").live("click",function(){var msgParent=$(this).parent();var thisPanel=$(this).closest(".case_detail_panel");if($(this).parent().hasClass("msg_closed")){msgParent.removeClass("msg_closed").addClass("msg_opened");msgParent.find("p.tos, p.ccs, p.subj").css({color:"black"});msgParent.css({opacity:"1"});var thisMsgId=msgParent.attr("data-id");$(this).next("div").find("div.msg_replies").load("lib/php/data/cases_messages_load.php",{type:"replies",thread_id:thisMsgId},function(){var newHeight=$(this).closest("div.msg")[0].scrollHeight;msgParent.animate({height:newHeight});if(thisPanel.data("searchOn")==="y"){var target=$(this).closest(".case_detail_panel");thisPanel.highlight(target.data("searchTerm"))}});$.post("lib/php/data/messages_process.php",{action:"mark_read",id:thisMsgId})}else{msgParent.removeClass("msg_opened").addClass("msg_closed");msgParent.find("div.msg_reply_text").hide().find("textarea").val("");msgParent.find("div.msg_forward").hide();msgParent.css({opacity:".5"});msgParent.animate({height:"90"})}});$("span.star_msg").live("click",function(event){event.stopPropagation();var thisId=$(this).closest("div.msg").attr("data-id");if($(this).hasClass("star_off")){$(this).removeClass("star_off").addClass("star_on");$(this).html('<img src = "html/ico/starred.png">');$.post("lib/php/data/messages_process.php",{action:"star_on",id:thisId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}})}else{$(this).removeClass("star_on").addClass("star_off");$(this).html('<img src = "html/ico/not_starred.png">');$.post("lib/php/data/messages_process.php",{action:"star_off",id:thisId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}})}});$("div.msg_actions a").live("click",function(event){event.preventDefault();var clickType=$(this).attr("class");var h=null;if(clickType==="forward"){h=$(this).closest("div.msg").height()+300;$(this).parent().siblings("div.msg_forward").show().find("select").chosen();$(this).closest("div.msg").height(h);$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(clickType)}if(clickType==="reply"){h=$(this).closest("div.msg").height()+250;$(this).closest("div.msg").height(h);$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(clickType)}});$("a.print").live("click",function(){elPrint($(this).closest(".msg"),"Messsage")});$("p.msg_to_more").live("click",function(event){event.preventDefault();var newHeight;var newMsgHeight;if($(this).hasClass("ex_tos")){var tos=$(this).siblings("p.tos");newHeight=tos[0].scrollHeight;if($(this).hasClass("expanded")){$(this).removeClass("expanded");tos.css({height:"20"});$(this).html('<a href="#">and others</a>');newMsgHeight=$(this).closest("div.msg").height()-newHeight;$(this).closest("div.msg").height(newMsgHeight)}else{tos.css({height:newHeight});$(this).addClass("expanded");$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>');newMsgHeight=$(this).closest("div.msg").height()+newHeight;$(this).closest("div.msg").height(newMsgHeight)}}else{var ccs=$(this).siblings("p.ccs");newHeight=ccs[0].scrollHeight;if($(this).hasClass("expanded")){$(this).removeClass("expanded");ccs.css({height:"20"});$(this).html('<a href="#">and others</a>');newMsgHeight=$(this).closest("div.msg").height()-newHeight;$(this).closest("div.msg").height(newMsgHeight)}else{ccs.css({height:newHeight});$(this).addClass("expanded");$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>');newMsgHeight=$(this).closest("div.msg").height()+newHeight;$(this).closest("div.msg").height(newMsgHeight)}}});$("input.cse_msg_search").live("focusin",function(){$(this).val("");$(this).css({color:"black"});$(this).next(".cse_msg_search_clear").show()});$("input.cse_msg_search").live("keyup",function(event){if(event.which===13&&$(this).val().length){var target=$(this).closest(".case_detail_panel");var caseId=target.data("CaseNumber");var dataTarget=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");target.data("startVal","0");target.data("searchOn","y");target.data("searchTerm",$(this).val());dataTarget.html("<p>Searching...</p>");var search=$(this).val();dataTarget.load("lib/php/data/cases_messages_load.php",{type:"search",start:"0",s:search,case_id:caseId},function(){dataTarget.scrollTop(0);layoutMessages();dataTarget.highlight(search)})}});$(".cse_msg_search_clear").live("click",function(){var target=$(this).closest(".case_detail_panel");var dataTarget=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");dataTarget.html("<p>Loading...</p>");target.data("searchOn","n");target.data("searchTerm","");target.data("startVal",0);$(this).prev().val("Search Messages");$(this).prev().css({color:"#AAA"});$(this).closest(".case_detail_panel").siblings(".case_detail_nav").find("li#item5").trigger("click");dataTarget[0].scrollTop=0;$(this).hide()});$("button.msg_send").live("click",function(){var replyText=$(this).prev().val();var threadId=$(this).closest("div.msg").attr("data-id");var actionType=$(this).prev().attr("class");var refreshTarget=$(this).parent().siblings("div.msg_replies");var msgParent=$(this).closest("div.msg");var forwardTos=$(this).parent().siblings("div.msg_forward").find("select").val();$.post("lib/php/data/messages_process.php",{action:actionType,thread_id:threadId,reply_text:replyText,forward_tos:forwardTos},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);refreshTarget.load("lib/php/data/cases_messages_load.php",{type:"replies",thread_id:threadId},function(){msgParent.animate({height:"90"});msgParent.removeClass("msg_read msg_opened").addClass("msg_unread msg_closed");msgParent.find("div.msg_reply_text").hide().find("textarea").val("");msgParent.find("div.msg_forward").hide();msgParent.find("div.msg_forward select").val("");$(this).closest(".case_detail_panel_casenotes").scrollTop(msgParent.data("verticalPos"))})}})});
//# sourceMappingURL=Cases.map