function sizeCaseNotes(e,t){var s=t.height(),a=.3*t.height();e.each(function(){$(this).data("maxCaseNoteHeight",$(this).height()),$(this).data("minCaseNoteHeight",a);var e=100*($(this).height()/s);e>40&&($(this).height(a),$(this).append('<div class="more"><a href="#">More</a></div>'),$(this).css({overflow:"hidden"}))})}function loadCaseNotes(e,t){$(e).load("lib/php/data/cases_casenotes_load.php",{case_id:t,non_case:"1",start:"0"},function(){$("div.case_detail_panel_tools").css({height:"15%"}),$("div.case_detail_panel_tools").css({"max-height":"60px"}),$("div.case_detail_panel_casenotes").css({height:"85%"}),$(".case_detail_panel_tools_right button.button1").length?$(".case_detail_panel_tools_right button.button1").button({icons:{primary:"fff-icon-add"},text:!0}).next().button({icons:{primary:"fff-icon-time"},text:!0}).next().button({icons:{primary:"fff-icon-printer"},text:!0}):$(".case_detail_panel_tools_right button.button3").button({icons:{primary:"fff-icon-printer"},text:!0});var s=$(e).find(".case_detail_panel_casenotes");s.data("CaseNumber",t),$(s).bind("scroll",function(){addMoreNotes(s)}),sizeCaseNotes($(e).find(".csenote"),$(e).find(".case_detail_panel_casenotes")),$("div.csenote").addClass("ui-corner-all"),$("#casesearch_NC").val("Search Non-Case")})}function addMoreNotes(e){var t=e.data("CaseNumber"),s=e[0].scrollTop,a=e[0].scrollHeight;0===s&&e.hasClass("csenote_shadow")?e.removeClass("csenote_shadow"):e.addClass("csenote_shadow");var n,i=100*(s/(a-e.height()));i>70&&(e.data("start")===void 0?(n=20,e.data("start",n)):(n=e.data("start")+20,e.data("start",n)),$.post("lib/php/data/cases_casenotes_load.php",{case_id:t,start:e.data("start"),non_case:"1",update:"yes"},function(t){var s=$(t).find("p.csenote_instance").length;return 0===s?!1:(e.append(t),sizeCaseNotes($(".csenote"),e),$("div.csenote").addClass("ui-corner-all"),"block"===e.find("div.csenote_new").css("display")&&$("div.csenote").css({opacity:".5"}),void 0)}))}String.prototype.nl2br=function(){var e;return e=arguments[0]!==void 0?arguments[0]:"<br />",this.replace(/\r\n|\r|\n/g,e)},String.prototype.br2nl=function(){var e;return e=arguments[0]!==void 0?arguments[0]:"\r",this.replace(/\<br(\s*\/|)\>/g,e)},$("div.more").live("click",function(e){e.preventDefault();var t=$(this).closest(".csenote"),s=$(this).closest(".csenote").data("minCaseNoteHeight");"Less"===$(this).find("a").html()?(t.css({height:s}),$(this).find("a").html("More")):(t.css({height:"auto"}),$(this).find("a").html("Less"))}),$("input.casenotes_search").live("focusin",function(){$(this).val(""),$(this).css({color:"black"}),$(this).next(".casenotes_search_clear").show()}),$("input.casenotes_search").live("keyup",function(){var e=$(this).closest("div.case_detail_panel_tools").next(),t=$(this).val(),s="NC";t.length>2&&(e.unbind("scroll"),e.load("lib/php/data/cases_casenotes_load.php",{case_id:s,search:t,update:"yes",non_case:"1"},function(){e.scrollTop(0),t.length&&e.highlight(t),sizeCaseNotes($(".csenote"),e),e.hasClass("csenote_shadow")&&e.removeClass("csenote_shadow"),$("div.csenote").addClass("ui-corner-all"),e.bind("scroll.search",function(){$(this).scrollTop()>0?$(this).addClass("csenote_shadow"):$(this).removeClass("csenote_shadow")})}))}),$(".casenotes_search_clear").live("click",function(){$(this).prev().val("Search Non-Case"),$(this).prev().css({color:"#AAA"});var e=$(this).closest("div.case_detail_panel_tools").next(),t=e.data("CaseNumber");e.load("lib/php/data/cases_casenotes_load.php",{case_id:t,start:"0",update:"yes",non_case:"1"},function(){e.scrollTop(0),sizeCaseNotes($(".csenote"),e),$("div.csenote").addClass("ui-corner-all"),e.unbind("scroll.search"),e.bind("scroll",function(){addMoreNotes(e)})}),$(this).hide()}),$(".case_detail_panel_tools_right button.button1").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var e=$(this).closest(".case_detail_panel_tools").siblings().find(".csenote_new");e.show(),$(this).closest(".case_detail_panel_tools").siblings().find("textarea").TextAreaExpander(52,200).css({color:"#AAA"}).html("Describe what you did...").mouseenter(function(){$(this).focus().val("").css({color:"black"}).unbind("mouseenter")}),$(this).closest(".case_detail_panel_tools").siblings().find("div.csenote").not("div.csenote_new").css({opacity:".5"});var t=$("input.csenote_date_value").val();$("input.csenote_date_value").datepicker({dateFormat:"m/d/yy",showOn:"button",buttonText:t,onSelect:function(e){$(this).next().html(e)}}),e.find(".csenote_action_submit").button({icons:{primary:"fff-icon-add"}}).next().button({icons:{primary:"fff-icon-cancel"},text:!0})}),$(".case_detail_panel_tools_right button.button2").live("click",function(){var e="Non-Case",t=new Date,s=t.getTime();$("#timer .timer_case_name").html(e),$.cookie("timer_status","on"),$.cookie("timer_start_time",s),$.cookie("timer_case_name",e);var a=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").data("CaseNumber");$.cookie("timer_case_id",a),ccTimer(!0,s),$("#timer").show()}),$(".case_detail_panel_tools_right button.button3").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Non-Case Time")}),$("button.csenote_action_cancel").live("click",function(e){e.preventDefault(),loadCaseNotes($("#noncase_panel"),"NC")}),$("button.csenote_action_submit").live("click",function(e){e.preventDefault();var t=$(this).closest("form").serializeArray();$(this).closest;var s=$(this).closest("div.case_detail_panel_casenotes"),a=s.data("CaseNumber"),n=validCaseNote(t);n.length?notify(n,!0):$.post("lib/php/data/cases_casenotes_process.php",t,function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),s.load("lib/php/data/cases_casenotes_load.php",{case_id:a,start:"0",non_case:"1",update:"yes"},function(){sizeCaseNotes($(".csenote"),s)}))})}),$("a.csenote_delete").live("click",function(e){e.preventDefault();var t=$(this).closest(".csenote"),s=t.attr("id").split("_"),a=$('<div class=".dialog-casenote-delete" title="Delete this Case Note?">This case note will be permanently deleted.  Are you sure?</div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/cases_casenotes_process.php",{query_type:"delete",csenote_casenote_id:s[1]},function(e){var s=$.parseJSON(e);s.error===!0?notify(s.message,!0):(t.remove(),notify(s.message))}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(a).dialog("open")}),$("a.csenote_edit").live("click",function(e){if(e.preventDefault(),$(this).closest(".case_detail_panel_casenotes").find(".csenote_edit_submit").length)return notify("Only one case note can be edited at a time",!0),!1;var t=$(this).closest(".csenote"),s=t.attr("id").split("_");t.find("span.highlight").length&&t.find("span.highlight").contents().unwrap();var a,n,i=t.find("p.csenote_instance").html().br2nl(),o=$(this).closest("div").children(".csenote_time").html();if(-1===o.indexOf("."))a="0",n=parseInt(o);else{var c=o.split(".");a=c[0],n=parseInt(c[1])}var l=$(this).closest("div").children(".csenote_date").html(),d=$(this).closest("div.csenote").siblings("div.csenote_new").eq(0).clone();t.after(d),d.show(),t.hide(),d.find(".csenote_bar").css({"background-color":"#FEBBBB"}),d.find("textarea").html(i).TextAreaExpander(52,200),d.find('select[name="csenote_hours"]').val(a),d.find('select[name="csenote_minutes"]').val(n),d.find('input[name="query_type"]').val("modify"),d.find("button.csenote_action_submit").html("Done").addClass("csenote_edit_submit").removeClass("csenote_action_submit"),d.find("input.csenote_date_value").val(l).datepicker({dateFormat:"m/d/yy",showOn:"button",buttonText:l,onSelect:function(e){$(this).next().html(e)}}),d.find("form").append('<input type="hidden" name="csenote_casenote_id" value="'+s[1]+'">'),d.find("button.csenote_action_cancel").unbind("click").bind("click",function(){d.remove(),t.show()}),d.find("button.csenote_action_submit").unbind(),d.find("button.csenote_edit_submit").bind("click",function(e){e.preventDefault();var s=$(this).closest("form").serializeArray(),a=validCaseNote(s);a.length?notify(a,"wait"):$.post("lib/php/data/cases_casenotes_process.php",s,function(e){var a=$.parseJSON(e);if(a.error===!0)notify(a.message,!0);else{t.find(".csenote_date").html(s[0].value);var n=s[6].value.nl2br();t.find("p.csenote_instance").html(n),"0"===s[1].value?t.find(".csenote_time").html(s[2].value+" minutes"):t.find(".csenote_time").html(s[1].value+"."+s[2].value+" hours"),notify(a.message),d.remove(),t.show()}})})});