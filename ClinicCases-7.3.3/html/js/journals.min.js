var oTable;$(document).ready(function(){var tableHeight=$("#content").height()-120;var chooserVal="unread";oTable=$("#table_journals").dataTable({sAjaxSource:"lib/php/data/journals_load.php",aoColumns:[{sTitle:"",bSortable:false,sWidth:"40px"},{sTitle:"Id",bSearchable:false,bVisible:false},{sTitle:"Name"},{sTitle:"Submitted To",bSearchable:true,bVisible:false},{sTitle:"Text",bVisible:false},{sTitle:"Date Submitted",sType:"date"},{sTitle:"Archived",bVisible:false},{sTitle:"Read",bVisible:false},{sTitle:"Commented",bVisible:false},{sTitle:"Comments",bSearchable:false,bVisible:false}],aoColumnDefs:[{fnRender:function(o){return String(o.aData[o.iDataColumn]).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},aTargets:[2,3,4,5,6,7,8,9]}],oColVis:{aiExclude:[0,1],bRestore:true,buttonText:"Columns"},oTableTools:{aButtons:[{sExtends:"text",sButtonText:"Reset",sButtonClass:"DTTT_button_reset",sButtonClassHover:"DTTT_button_reset_hover"},{sExtends:"text",sButtonText:"New Journal",sButtonClass:"DTTT_button_new_case",sButtonClassHover:"DTTT_button_new_case_hover"}]},aaSorting:[[5,"desc"]],bDeferRender:true,bAutoWidth:false,bProcessing:true,bJQueryUI:true,bScrollInfinite:true,sScrollY:tableHeight,iDisplayLength:30,iScrollLoadGap:200,bSortCellsTop:true,sDom:'R<"H"fTCi>rt<"F"<"journal_action">>',oLanguage:{sInfo:'Showing <b>_TOTAL_</b> <span id="journalStatus"></span> journals',sZeroRecords:'No <span id="journalStatus"></span> journals found.',sInfoEmpty:"Showing 0 journals",sInfoFiltered:"from a total of <b>_MAX_</b>",sEmptyTable:"No journals found."},fnInitComplete:function(){$("#processing").hide();$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default");$("div.journal_action").html('<label>With displayed journals:</label><select id="journal_action_chooser">'+'<option value="" selected=selected disabled>Choose Action</option><option value="archive">Archive</option>'+'<option value="mark_read">Mark Read</option><option value="mark_unread">Mark Unread</option></select>');$("#journal_action_chooser").change(function(){var filteredData=oTable.fnGetFilteredData();var affectedJournals=[];var action=$(this).val();var actionText=action.replace("_"," as ");$.each(filteredData,function(){affectedJournals.push($(this)[1])});var dialogWin=$('<div title="Are you sure?">This will '+actionText+" "+filteredData.length+" journals.  Are you sure you want to do that?</div>").dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/journals_process.php",{type:action,id:affectedJournals},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);oTable.fnReloadAjax();fnResetAllFilters();chooserVal="unread"}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$("div.dataTables_filter").append('<select id="chooser"><option value="unread" selected=selected>'+'Unread</option><option value="read">Read</option><option value="archived">Archived</option>'+'<option value="all">All</option></select>');$("#chooser").live("change",function(){switch($(this).val()){case"unread":chooserVal="unread";oTable.fnFilter("^$",oTable.fnGetColumnIndex("Read"),true,false);oTable.fnFilter("",oTable.fnGetColumnIndex("Archived"));break;case"read":chooserVal="read";oTable.fnFilter("yes",oTable.fnGetColumnIndex("Read"),true,false);oTable.fnFilter("",oTable.fnGetColumnIndex("Archived"));break;case"archived":chooserVal="archived";oTable.fnFilter("yes",oTable.fnGetColumnIndex("Archived"));oTable.fnFilter("",oTable.fnGetColumnIndex("Read"));break;case"all":chooserVal="all";oTable.fnFilter("",oTable.fnGetColumnIndex("Archived"),true,false);oTable.fnFilter("",oTable.fnGetColumnIndex("Read"),true,false);break}});oTable.fnFilter("^$",oTable.fnGetColumnIndex("Read"),true,false);oTable.fnFilter("^$",oTable.fnGetColumnIndex("Archived"),true,false);$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default");$("#ToolTables_table_journals_0").click(function(){fnResetAllFilters()});if(!$("#table_journals").hasClass("can_add")){$("#ToolTables_table_journals_1").remove()}else{$("#ToolTables_table_journals_1").click(function(){$.post("lib/php/data/journals_process.php",{type:"new"},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{var newId=serverResponse.newId;callJournal(newId,true,true)}})})}$("#table_journals tbody").click(function(event){var iPos=oTable.fnGetPosition(event.target.parentNode);var aData=oTable.fnGetData(iPos);var iId=aData[1];callJournal(iId,false,false)});$(window).bind("resize",function(){oTable.fnDraw(false);oTable.fnAdjustColumnSizing()});router()},fnDrawCallback:function(){$("#journalStatus").text(chooserVal)}})});function callJournal(id,edit,newJournal){var journalId=[];journalId.push(id);if($("div#journal_detail_window").length<1){var journalDetail='<div id="journal_detail_window"></div>';$("#content").append(journalDetail)}if(edit===true){$("#journal_detail_window").load("lib/php/data/journals_detail_load.php",{id:journalId,view:"edit"},function(){$(this).show("fold",1e3,function(){var arr=$(this).find(".journal_edit").rte({css:["lib/javascripts/lwrte/default2.css"],width:900,height:500,controls_rte:rte_toolbar});var lastText="";var editor=$("#journal_detail_window");function autoSave(lastText,arr){var text=arr[0].get_content();var readers=$('select[name="reader_select[]"]').val();var status="Saving...";if(text!==lastText){editor.find("span.save_status").html(status);$.post("lib/php/data/journals_process.php",{type:"edit",id:journalId,text:text,readers:readers},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error){editor.find("span.save_status").html(serverResponse.message)}else{editor.find("span.save_status").html(serverResponse.message)}});lastText=text}var t=setTimeout(function(){autoSave(lastText,arr)},3e3)}autoSave(lastText,arr)});$(window).bind("beforeunload",function(){var rSelect=$('select[name="reader_select[]"]');if(rSelect.length>0&&rSelect.val()===null){rSelect.parent().find("label").first().addClass("ui-state-error");return"You haven't specified who is supposed to read this journal."+"Please select a reader in the box below."}});$("button.journal_close").button({icons:{primary:"fff-icon-cancel"},label:"Close"}).click(function(){var rSelect=$('select[name="reader_select[]"]');if(rSelect.length>0&&rSelect.val()===null){notify("<p>Please select the users to whom this journal is to be sent.</p>",true);rSelect.parent().find("label").first().addClass("ui-state-error");return false}else{oTable.fnReloadAjax();$("#journal_detail_window").hide("fold",1e3)}});$('select[name="reader_select[]"]').chosen().change(function(){if($('input[name="remember_choice"]').is(":checked")){var choice=$('select[name="reader_select[]"]').val();$.cookie("ClinicCases_journal",choice,{expires:365})}var readers=$('select[name="reader_select[]"]').val();$.post("lib/php/data/journals_process.php",{type:"update_readers",id:journalId,readers:readers})});if(newJournal===true){if($.cookie("ClinicCases_journal")!==null){var setVals=$.cookie("ClinicCases_journal").split(",");$('select[name="reader_select[]"]').val(setVals);$('select[name="reader_select[]"]').trigger("liszt:updated");$('input[name = "remember_choice"]').attr("checked","checked")}}else if(newJournal===false&&edit===true){if($.cookie("ClinicCases_journal")!==null){$('input[name = "remember_choice"]').attr("checked","checked")}}$('input[name = "remember_choice"]').change(function(){var choice=$('select[name="reader_select[]"]').val();if($(this).is(":checked")){$.cookie("ClinicCases_journal",choice,{expires:365})}else{if($.cookie("ClinicCases_journal")!==null){$.cookie("ClinicCases_journal",null)}}})})}else{$("#journal_detail_window").load("lib/php/data/journals_detail_load.php",{id:journalId},function(){$(this).show("fold",1e3);$.post("lib/php/data/journals_process.php",{id:journalId,type:"mark_read"},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message)}});if($("button.journal_delete").length){$("button.journal_delete").button({icons:{primary:"fff-icon-page-delete"}}).click(function(){var dialogWin=$('<div title="Are you sure?"><p>Permanently delete this journal?</p></div>').dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/journals_process.php",{id:journalId,type:"delete"},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);oTable.fnReloadAjax();$("#journal_detail_window").hide("fold",1e3)}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")})}if($("button.journal_edit").length){$("button.journal_edit").button({icons:{primary:"fff-icon-page-edit"}}).click(function(){callJournal(journalId[0],true,false)})}if($("button.journal_print").length){$("button.journal_print").button({icons:{primary:"fff-icon-printer"}}).click(function(){elPrint($("div.journal_detail"),"Journal")})}$("button.journal_close").button({icons:{primary:"fff-icon-cancel"},label:"Close"}).click(function(){oTable.fnReloadAjax();$("#journal_detail_window").hide("fold",1e3)});$("textarea.expand").livequery(function(){$(this).TextAreaExpander(40,300).css({color:"#AAA"}).bind("focus",function(){$(this).val("").css({color:"black"}).unbind("focus")})})})}}function fnResetAllFilters(){var oSettings=oTable.fnSettings();oTable.fnFilter("");ColReorder.fnReset(oTable);$("input").each(function(){this.value=""});$("select").each(function(){this.selectedIndex="0"});oTable.fnFilter("^$",oTable.fnGetColumnIndex("Read"),true,false);var chooserVal="open";oTable.fnSort([[oTable.fnGetColumnIndex("Date Submitted"),"desc"]]);oTable.fnDraw()}$("a.comment_save").live("click",function(event){event.preventDefault();var journalId=[];journalId.push($(this).closest("div.journal_body").attr("data-id"));var commentText=$(this).siblings("textarea").val();$.post("lib/php/data/journals_process.php",{type:"add_comment",id:journalId,comment_text:commentText},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message)}else{$("div.journal_comments").load("lib/php/data/journals_detail_load.php div.journal_comments",{id:journalId});notify(serverResponse.message)}})});$("a.comment_delete").live("click",function(event){event.preventDefault();var commentId=$(this).parent().attr("data-id");var journalId=[];journalId.push($(this).closest("div.journal_body").attr("data-id"));var dialogWin=$('<div title="Are you sure?"><p>Delete this comment?</p></div>').dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/journals_process.php",{type:"delete_comment",id:journalId,comment_id:commentId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message)}else{$("div.journal_comments").load("lib/php/data/journals_detail_load.php div.journal_comments",{id:journalId});notify(serverResponse.message)}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$(function(){$("div.comment").livequery(function(){if($(this).hasClass("can_delete")){$(this).mouseover(function(){$(this).find("a.comment_delete").show()}).mouseout(function(){$(this).find("a.comment_delete").hide()})}})});
//# sourceMappingURL=Journals.map