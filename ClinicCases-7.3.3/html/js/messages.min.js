function addMoreMessages(scrollTarget,view){var scrollAmount=scrollTarget[0].scrollTop;var scrollHeight=scrollTarget[0].scrollHeight;var scrollPercent=scrollAmount/(scrollHeight-scrollTarget.height())*100;var startNum;if(scrollPercent>70){if(typeof scrollTarget.data("startVal")==="undefined"){startNum=20;scrollTarget.data("startVal",startNum)}else{startNum=scrollTarget.data("startVal")+parseInt(20);scrollTarget.data("startVal",startNum)}if(scrollTarget.data("searchOn")==="y"){$.post("lib/php/data/messages_load.php",{type:view,start:scrollTarget.data("startVal"),s:scrollTarget.data("searchTerm")},function(data){var t=$(data).find("div").length;if(t===0){return false}else{scrollTarget.append(data);layoutMessages();scrollTarget.highlight(scrollTarget.data("searchTerm"))}})}else{$.post("lib/php/data/messages_load.php",{type:view,start:scrollTarget.data("startVal")},function(data){var t=$(data).find("div").length;if(t===0){return false}else{scrollTarget.append(data);layoutMessages()}})}}}function checkOverflow(target){var el=target[0];var curOverflow=el.style.overflow;if(!curOverflow||curOverflow==="visible"){el.style.overflow="hidden"}var isOverflowing=el.clientWidth<el.scrollWidth||el.clientHeight<el.scrollHeight;el.style.overflow=curOverflow;return isOverflowing}function layoutMessages(){var oFlow;$("p.tos").each(function(){if(!$(this).next("p").hasClass("msg_to_more")){oFlow=checkOverflow($(this));if(oFlow===true){$(this).css({overflowY:"hidden"});$(this).after('<p class="msg_to_more ex_tos"><a href="#">and others</a></p>')}}});$("p.ccs").each(function(){if(!$(this).next("p").hasClass("msg_to_more")){oFlow=checkOverflow($(this));if(oFlow===true){$(this).css({overflowY:"hidden"});$(this).after('<p class="msg_to_more"><a href="#">and others</a></p>')}}});$("div.msg").addClass("ui-corner-all");$("div.msg_read").css({opacity:".5"})}function msgLoad(){$.post("lib/php/data/messages_load.php",{type:"inbox",start:"0"},function(data){$("div#msg_panel").html(data);$("div.msg").addClass("ui-corner-all");$("div#msg_panel").data("startVal",0);layoutMessages()})}$(document).ready(function(){var target=$("div#msg_panel");var start=target.data("startVal");$("#msg_nav").addClass("ui-toolbar ui-widget-header ui-corner-tl ui-corner-tr");msgLoad();var msgRefresh=setInterval(msgLoad,9e4);$("div.msg_bar").live("click",function(){var msgParent=$(this).parent();if($(this).parent().hasClass("msg_closed")){msgParent.removeClass("msg_closed").addClass("msg_opened");msgParent.find("p.tos, p.ccs, p.subj").css({color:"black"});msgParent.css({opacity:"1"});var thisMsgId=msgParent.attr("data-id");msgParent.data("verticalPos",$("div#msg_panel")[0].scrollTop);clearTimeout(msgRefresh);$(this).next("div").find("div.msg_replies").load("lib/php/data/messages_load.php",{type:"replies",thread_id:thisMsgId},function(){var newHeight=$(this).closest("div.msg")[0].scrollHeight;msgParent.animate({height:newHeight});if(target.data("searchOn")==="y"){target.highlight(target.data("searchTerm"))}});$.post("lib/php/data/messages_process.php",{action:"mark_read",id:thisMsgId},function(){msgCheck()})}else{msgParent.removeClass("msg_opened").addClass("msg_closed");msgParent.find("div.msg_reply_text").hide().find("textarea").val("");msgParent.find("div.msg_forward").hide();msgParent.css({opacity:".5"});msgParent.animate({height:"90"});msgRefresh=setInterval(msgLoad,9e4)}});$("button#msg_archive_all_button").button({icons:{primary:"fff-icon-email-go"},text:true}).click(function(){var dialogWin=$('<div title="Send All to Archive?">Send all messages in inbox to archive?</div>').dialog({autoOpen:false,resizable:false,modal:true,buttons:{Yes:function(){$.post("lib/php/data/messages_process.php",{action:"archive_all"},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);msgLoad();msgCheck()}});$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(dialogWin).dialog("open")});$("button#new_msg_button").button({icons:{primary:"fff-icon-email-add"},text:true}).click(function(){$("div#msg_panel").load("lib/php/data/messages_load.php #msg_new",{new_message:"y"},function(){clearTimeout(msgRefresh);var newMsg=$("div#msg_new");newMsg.show().addClass("msg_opened");newMsg.find('select[name = "new_tos[]"], select[name = "new_ccs[]"], select[name = "new_file_msg"]').chosen();$("#msg_new_button_cancel").click(function(event){event.preventDefault();$("#new_msg_form")[0].reset();newMsg.removeClass("msg_opened");msgLoad();msgRefresh=setInterval(msgLoad,9e4);notify("New message cancelled")});$("#msg_new_button_submit").click(function(event){event.preventDefault();var msgVals=$("#new_msg_form").serializeArray();if($('select[name="new_tos"]').val()===null){notify("<p>You must select at least one recipient</p>");return false}else{$.post("lib/php/data/messages_process.php",msgVals,function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{$("#new_msg_form")[0].reset();msgLoad();msgRefresh=setInterval(msgLoad,9e4);notify("Message sent")}})}})})});$("select#msg_view_chooser").change(function(){var view=$(this).val();if(view!=="inbox"){clearTimeout(msgRefresh)}else{msgRefresh=setInterval(msgLoad,9e4)}target.html("<p>Loading...</p>");$.post("lib/php/data/messages_load.php",{type:view,start:"0"},function(data){target.html(data);target.data("startVal",0);layoutMessages();$("div#msg_panel")[0].scrollTop=0})});target.bind("scroll",function(){var view=null;if(target.data("searchOn")==="y"){view="search"}else{view=$("select#msg_view_chooser").val()}addMoreMessages(target,view)});$("span.star_msg").live("click",function(event){event.stopPropagation();var thisId=$(this).closest("div.msg").attr("data-id");if($(this).hasClass("star_off")){$(this).removeClass("star_off").addClass("star_on");$(this).html('<img src = "html/ico/starred.png">');$.post("lib/php/data/messages_process.php",{action:"star_on",id:thisId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}})}else{$(this).removeClass("star_on").addClass("star_off");$(this).html('<img src = "html/ico/not_starred.png">');$.post("lib/php/data/messages_process.php",{action:"star_off",id:thisId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}})}});$("div.msg_actions a").live("click",function(event){event.preventDefault();var clickType=$(this).attr("class");var h;$(this).parent().siblings("div.msg_reply_text").show().find("textarea").removeClass();if(clickType==="forward"){h=$(this).closest("div.msg").height()+300;$(this).parent().siblings("div.msg_forward").show().find("select").chosen();$(this).closest("div.msg").height(h);$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(clickType)}if(clickType==="reply"){h=$(this).closest("div.msg").height()+250;$(this).closest("div.msg").height(h);$(this).parent().siblings("div.msg_forward").hide();$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(clickType)}});$("button.msg_send").live("click",function(){var replyText=$(this).prev().val();var threadId=$(this).closest("div.msg").attr("data-id");var actionType=$(this).prev().attr("class");var refreshTarget=$(this).parent().siblings("div.msg_replies");var msgParent=$(this).closest("div.msg");var forwardTos=$(this).parent().siblings("div.msg_forward").find("select").val();$.post("lib/php/data/messages_process.php",{action:actionType,thread_id:threadId,reply_text:replyText,forward_tos:forwardTos},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);refreshTarget.load("lib/php/data/messages_load.php",{type:"replies",thread_id:threadId},function(){msgParent.animate({height:"90"});msgParent.removeClass("msg_opened").addClass("msg_closed").css({opacity:".5"});msgParent.find("div.msg_reply_text").hide().find("textarea").val("");msgParent.find("div.msg_forward").hide();msgParent.find("div.msg_forward select").val("");$("div#msg_panel").scrollTop(msgParent.data("verticalPos"))})}})});$("a.archive, a.unarchive").live("click",function(){var msg=$(this).closest("div.msg");var msgId=msg.attr("data-id");var thisAction=$(this).attr("class");$.post("lib/php/data/messages_process.php",{action:thisAction,id:msgId},function(data){var serverResponse=$.parseJSON(data);if(serverResponse.error===true){notify(serverResponse.message,true)}else{notify(serverResponse.message);msg.remove()}})});$("a.print").live("click",function(){elPrint($(this).closest(".msg"),"Message")});$("p.msg_to_more").live("click",function(event){event.preventDefault();var newHeight,newMsgHeight;if($(this).hasClass("ex_tos")){var tos=$(this).siblings("p.tos");newHeight=tos[0].scrollHeight;if($(this).hasClass("expanded")){$(this).removeClass("expanded");tos.css({height:"20"});$(this).html('<a href="#">and others</a>');newMsgHeight=$(this).closest("div.msg").height()-newHeight;$(this).closest("div.msg").height(newMsgHeight)}else{tos.css({height:newHeight});$(this).addClass("expanded");$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>');newMsgHeight=$(this).closest("div.msg").height()+newHeight;$(this).closest("div.msg").height(newMsgHeight)}}else{var ccs=$(this).siblings("p.ccs");newHeight=ccs[0].scrollHeight;if($(this).hasClass("expanded")){$(this).removeClass("expanded");ccs.css({height:"20"});$(this).html('<a href="#">and others</a>');newMsgHeight=$(this).closest("div.msg").height()-newHeight;$(this).closest("div.msg").height(newMsgHeight)}else{ccs.css({height:newHeight});$(this).addClass("expanded");$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>');newMsgHeight=$(this).closest("div.msg").height()+newHeight;$(this).closest("div.msg").height(newMsgHeight)}}});$("input.messages_search").live("focusin",function(){$(this).val("");$(this).css({color:"black"});$(this).next(".msg_search_clear").show()});$("input.messages_search").live("keyup",function(event){if(event.which===13){clearTimeout(msgRefresh);target.data("startVal",0);target.data("searchOn","y");target.data("searchTerm",$(this).val());target.html("<p>Searching...</p>");var search=$(this).val();target.load("lib/php/data/messages_load.php",{type:"search",start:"0",s:search},function(){target.scrollTop(0);layoutMessages();$("div.msg_bar_left").css({width:"470px"});$("div.msg_bar_right").css({width:"310px"});target.highlight(search)})}});$(".msg_search_clear").live("click",function(){target.html("<p>Loading...</p>");target.data("searchOn","n");target.data("searchTerm","");target.data("startVal",0);$(this).prev().val("Search Messages");$(this).prev().css({color:"#AAA"});msgLoad();msgRefresh=setInterval(msgLoad,9e4);$("div#msg_panel")[0].scrollTop=0;$(this).hide()})});
//# sourceMappingURL=Messages.map